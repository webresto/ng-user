!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("@webresto/ng-core"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("@webresto/ng-user",["exports","@angular/core","rxjs","rxjs/operators","@webresto/ng-core","@angular/common/http"],t):t((e.webresto=e.webresto||{},e.webresto["ng-user"]={}),e.ng.core,e.rxjs,e.rxjs.operators,null,e.ng.common.http)}(this,function(e,n,s,o,i,t){"use strict";var u="gf:tkn:v2",r=function(){function e(e,t){var r=this;this.net=e,this.eventer=t,this.rememberMe=!1,this.user=new s.BehaviorSubject({}),this.isLoggedIn=new s.BehaviorSubject(!1),this.favorites=new s.BehaviorSubject([]),this.addresses=new s.BehaviorSubject([]),this.historyItems=new s.BehaviorSubject([]),this.historyTransactions=new s.BehaviorSubject([]),this.authToken=localStorage.getItem(u),this.authToken&&this.isLoggedIn.next(!0),this.isLoggedIn.subscribe(function(e){e&&setTimeout(function(){r.getFavorites().subscribe(),r.getProfile().subscribe(),r.getAddresses().subscribe(),r.getHistory().subscribe(),r.getHistoryTransactions().subscribe()},500)}),this.eventer.getMessageEmitter().subscribe(function(e){switch(e.type){case"Unauthorized":r.deleteAuthToken()}})}return e.prototype.signIn=function(e,t){var r=this;return void 0===t&&(t=!1),this.rememberMe=t,this.net.post("/signin",e).pipe(o.tap(function(e){r.setAuthToken(e.token,!1),r.user.next(e.user),r.eventer.emitMessageEvent(new i.EventMessage("success","Успех","Успешно авторизирован"))},function(e){return r.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.getProfile=function(){var t=this;return this.net.get("/user/get/user-info").pipe(o.tap(function(e){t.user.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.getHistory=function(){var t=this;return this.net.get("/user/get/history").pipe(o.tap(function(e){t.historyItems.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.getHistoryTransactions=function(){var t=this;return this.net.get("/bonus/transactions").pipe(o.tap(function(e){t.historyTransactions.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.updateProfile=function(e){var t=this;return this.net.post("/user/set/user-info",{user:e}).pipe(o.tap(function(e){t.user.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.getAddresses=function(){var t=this;return this.net.get("/user/get/location").pipe(o.tap(function(e){t.addresses.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.addAddress=function(e){var t=this;return this.net.post("/user/add/location",e).pipe(o.tap(function(e){t.addresses.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.deleteAddress=function(e){var t=this,r={id:e.id,street:e.street,home:e.home};return this.net.post("/user/remove/location",r).pipe(o.tap(function(e){t.addresses.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.signUp=function(e){var t=this;return this.net.post("/signup",e).pipe(o.tap(function(e){t.eventer.emitMessageEvent(new i.EventMessage("success","Регистрация","Ваш пароль был отправлен на указанный номер телефона"))},function(e){t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.signOut=function(){return this.deleteAuthToken()},e.prototype.getBonuses=function(){var t=this;return this.net.post("/bonus/get",{}).pipe(o.tap(function(e){},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.resetPassword=function(e){var t=this;return this.net.post("/reset",e).pipe(o.tap(function(e){},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.resetPasswordCode=function(e){var t=this;return this.net.post("/code",e).pipe(o.tap(function(e){},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.getFavorites=function(){var t=this;return this.net.get("/user/get/favorites ").pipe(o.tap(function(e){console.info("getFavorites result",e),t.favorites.next(e)},function(e){return t.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.addDishToFavorites=function(r){var n=this,e={dishId:r.id};return this.net.post("/user/add/favorites ",e).pipe(o.tap(function(e){var t=n.favorites.getValue();t.push(r),n.favorites.next(t)},function(e){return n.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.removeDishFromFavorites=function(r){var n=this,e={dishId:r.id};return this.net.post("/user/remove/favorites ",e).pipe(o.tap(function(e){console.info("Было=>>>",n.favorites.getValue().length);var t=n.favorites.getValue().filter(function(e){return e.id!=r.id});console.info("Стало=>>>",t.length),n.favorites.next(t)},function(e){return n.eventer.emitMessageEvent(new i.EventMessage("error","Ошибка",e))}))},e.prototype.userProfile=function(){return this.user},e.prototype.userIsLoggedIn=function(){return this.isLoggedIn},e.prototype.userFavorites=function(){return this.favorites},e.prototype.userAddresses=function(){return this.addresses},e.prototype.userHistory=function(){return this.historyItems},e.prototype.userTransactionsHistory=function(){return this.historyTransactions},e.prototype.getAuthToken=function(){return this.authToken},e.prototype.setAuthToken=function(e,t){void 0===t&&(t=!0),this.rememberMe&&(localStorage.setItem(u,e),localStorage.removeItem("gf:login:phone")),this.authToken=e,this.isLoggedIn.next(!0)},e.prototype.deleteAuthToken=function(){this.authToken=undefined,localStorage.removeItem(u),localStorage.removeItem("gf:login:phone"),this.isLoggedIn.next(!1)},e.decorators=[{type:n.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:i.NetService},{type:i.EventerService}]},e.ngInjectableDef=n.defineInjectable({factory:function(){return new e(n.inject(i.NetService),n.inject(i.EventerService))},token:e,providedIn:"root"}),e}();function c(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,s,o=r.call(e),i=[];try{for(;(void 0===t||0<t--)&&!(n=o.next()).done;)i.push(n.value)}catch(u){s={error:u}}finally{try{n&&!n.done&&(r=o["return"])&&r.call(o)}finally{if(s)throw s.error}}return i}function a(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e}var p=function(){function e(e){this.ngRestoUserService=e,this.success=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.onClick=function(){var t=this,e={name:this.name,phone:this.preparePhone(this.phone),email:this.email,password:this.password,captcha:this.captcha};this.ngRestoUserService.signUp(e).subscribe(function(){return t.success.emit(!0)},function(e){return t.error.emit(e)})},e.prototype.preparePhone=function(e){return(e="+"+e.replace(/[^0-9]/gim,"")).replace("+8","")},e.decorators=[{type:n.Directive,args:[{selector:"[appSignUp]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={name:[{type:n.Input}],phone:[{type:n.Input}],email:[{type:n.Input}],password:[{type:n.Input}],captcha:[{type:n.Input}],success:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),h=function(){function e(e){this.ngRestoUserService=e,this.success=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.onClick=function(){var t=this,e={phone:this.preparePhone(this.phone),password:this.password,captcha:this.captcha};this.ngRestoUserService.signIn(e,this.rememberMe).subscribe(function(){return t.success.emit(!0)},function(e){return t.error.emit(e)})},e.prototype.preparePhone=function(e){return(e="+"+e.replace(/[^0-9]/gim,"")).replace("+8","")},e.decorators=[{type:n.Directive,args:[{selector:"[appSignIn]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={phone:[{type:n.Input}],password:[{type:n.Input}],captcha:[{type:n.Input}],rememberMe:[{type:n.Input}],success:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),v=function(){function e(e){this.ngRestoUserService=e}return e.prototype.onClick=function(){this.ngRestoUserService.signOut()},e.decorators=[{type:n.Directive,args:[{selector:"[appSignOut]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={onClick:[{type:n.HostListener,args:["click"]}]},e}(),f=function(){function e(e){this.ngRestoUserService=e,this.success=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.onClick=function(){var t=this,e={phone:this.phone,captcha:this.captcha};this.ngRestoUserService.resetPassword(e).subscribe(function(){return t.success.emit(!0)},function(e){return t.error.emit(e)})},e.decorators=[{type:n.Directive,args:[{selector:"[appResetPassword]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={phone:[{type:n.Input}],captcha:[{type:n.Input}],success:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),d=function(){function e(e){this.ngRestoUserService=e,this.success=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.onClick=function(){var t=this,e={userId:this.userId,code:this.code,password:this.password};this.ngRestoUserService.resetPasswordCode(e).subscribe(function(){return t.success.emit(!0)},function(e){return t.error.emit(e)})},e.decorators=[{type:n.Directive,args:[{selector:"[appResetPasswordCode]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={userId:[{type:n.Input}],code:[{type:n.Input}],password:[{type:n.Input}],success:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),g=function(){function e(e,t,r){var n=this;this.renderer=e,this.el=t,this.ngRestoUserService=r;var s=0;this.ngRestoUserService.getBonuses().subscribe(function(e){for(var t in e){var r=e[t];"active"==r.state&&(s+=r.balance)}n.amount=""+s,n.renderer.setProperty(n.el.nativeElement,"innerHTML",n.amount)})}return e.decorators=[{type:n.Directive,args:[{selector:"[appBalance]"}]}],e.ctorParameters=function(){return[{type:n.Renderer2},{type:n.ElementRef},{type:r}]},e}(),m=function(){function e(e,t,r){this.ngRestoUserService=e,this.element=t,this.renderer=r,this.addedToFavorites=new n.EventEmitter,this.removedFromFavorites=new n.EventEmitter,this.change=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.ngOnInit=function(){var t=this;this.ngRestoUserService.userFavorites().subscribe(function(e){t.inFavorites=e.find(function(e){return e.id==t.dish.id}),t.inFavorites?t.renderer.addClass(t.element.nativeElement,"selected"):t.renderer.removeClass(t.element.nativeElement,"selected")}),this.ngRestoUserService.userIsLoggedIn().subscribe(function(e){return t.isLoggedIn=e})},e.prototype.onClick=function(){this.inFavorites?this.removeDishFromFavorites():this.addDishToFavorites()},e.prototype.addDishToFavorites=function(){var t=this;this.ngRestoUserService.addDishToFavorites(this.dish).subscribe(function(){t.addedToFavorites.emit(),t.change.emit(!0),t.renderer.addClass(t.element.nativeElement,"selected")},function(e){return t.error.emit(e)})},e.prototype.removeDishFromFavorites=function(){var t=this;this.ngRestoUserService.removeDishFromFavorites(this.dish).subscribe(function(){t.removedFromFavorites.emit(),t.change.emit(!1),t.renderer.removeClass(t.element.nativeElement,"selected")},function(e){return t.error.emit(e)})},e.decorators=[{type:n.Directive,args:[{selector:"[appToggleDishToFavorites]"}]}],e.ctorParameters=function(){return[{type:r},{type:n.ElementRef},{type:n.Renderer2}]},e.propDecorators={dish:[{type:n.Input}],addedToFavorites:[{type:n.Output}],removedFromFavorites:[{type:n.Output}],change:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),y=function(){function e(e){this.ngRestoUserService=e,this.success=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.onClick=function(){var t=this,e={name:this.name,email:this.email};this.ngRestoUserService.updateProfile(e).subscribe(function(){return t.success.emit(!0)},function(e){return t.error.emit(e)})},e.decorators=[{type:n.Directive,args:[{selector:"[appUpdateProfile]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={name:[{type:n.Input}],phone:[{type:n.Input}],email:[{type:n.Input}],success:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),l=function(){function e(e){this.ngRestoUserService=e,this.success=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.onClick=function(){var t=this;if(this.street)if(this.home){var e={street:this.street,home:this.home,name:this.name||"",housing:this.housing||"",index:this.index||"",entrance:this.entrance||"",floor:this.floor||"",apartment:this.apartment||"",doorphone:this.doorphone||""};this.ngRestoUserService.addAddress(e).subscribe(function(){return t.success.emit(!0)},function(e){return t.error.emit(e)})}else this.error.emit("Необходимо указать номер дома");else this.error.emit("Необходимо указать улицу")},e.decorators=[{type:n.Directive,args:[{selector:"[appAddAddress]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={street:[{type:n.Input}],home:[{type:n.Input}],name:[{type:n.Input}],housing:[{type:n.Input}],index:[{type:n.Input}],entrance:[{type:n.Input}],floor:[{type:n.Input}],apartment:[{type:n.Input}],doorphone:[{type:n.Input}],success:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),E=function(){function e(e){this.ngRestoUserService=e,this.success=new n.EventEmitter,this.error=new n.EventEmitter}return e.prototype.onClick=function(){var t=this;this.ngRestoUserService.deleteAddress(this.address).subscribe(function(){return t.success.emit(!0)},function(e){return t.error.emit(e)})},e.decorators=[{type:n.Directive,args:[{selector:"[appDeleteAddress]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={address:[{type:n.Input}],success:[{type:n.Output}],error:[{type:n.Output}],onClick:[{type:n.HostListener,args:["click"]}]},e}(),b=[p,h,v,f,d,g,m,y,l,E],I=function(){function e(){}return e.decorators=[{type:n.NgModule,args:[{imports:[],providers:[],declarations:a(b),exports:a(b)}]}],e}(),w=function(){function e(e){this.userService=e}return e.prototype.intercept=function(e,t){console.info("AuthInterceptor",e);var r=this.userService.getAuthToken();if(r){var n=e.clone({headers:e.headers.set("Authorization","JWT "+r)});return t.handle(n)}return t.handle(e)},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:r}]},e}(),S=[{provide:t.HTTP_INTERCEPTORS,useClass:w,multi:!0}];e.NgRestoUserService=r,e.NgUserModule=I,e.ngUserHttpInterceptorProviders=S,e.AuthInterceptor=w,e.ɵj=l,e.ɵg=g,e.ɵk=E,e.ɵf=d,e.ɵe=f,e.ɵc=h,e.ɵd=v,e.ɵa=p,e.ɵh=m,e.ɵi=y,e.ɵb=r,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=webresto-ng-user.umd.min.js.map