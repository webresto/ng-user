!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@webresto/ng-core"),require("rxjs"),require("rxjs/operators"),require("@angular/common")):"function"==typeof define&&define.amd?define("@webresto/ng-user",["exports","@angular/core","@webresto/ng-core","rxjs","rxjs/operators","@angular/common"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).webresto=e.webresto||{},e.webresto["ng-user"]={}),e.ng.core,e["@webresto/ng-core"],e.rxjs,e.rxjs.operators,e.ng.common)}(this,(function(e,t,r,s,n,i){"use strict";var o="gf:tkn:v2",u=function(){function e(e){var t=this;this.net=e,this.authToken=localStorage.getItem(o),this.rememberMe=!1,this.isLoggedIn=new s.BehaviorSubject(!!this.authToken),this.historyItems=new s.BehaviorSubject([]),this.historyTransactions=new s.BehaviorSubject([]);var r=this.isLoggedIn.pipe(n.filter((function(e){return!!e})),n.switchMap((function(){return t.getFavorites()})),n.switchMap((function(){return t.getProfile()})),n.switchMap((function(){return t.getAddresses()})),n.switchMap((function(){return t.getBonuses()}))).subscribe((function(){}),(function(){}),(function(){return r.unsubscribe()}))}return e.prototype.signIn=function(e,t){var r=this;return void 0===t&&(t=!1),this.rememberMe=t,this.net.post("/signin",e).pipe(n.tap((function(e){r.setAuthToken(e.token),r.user.next(e.user),r.isLoggedIn.next(!0)}),(function(){})))},e.prototype.getProfile=function(){var e=this;return this.user?this.user:this.net.get("/user/get/user-info").pipe(n.switchMap((function(t){return e.user=new s.BehaviorSubject(t),e.user})))},e.prototype.getHistory=function(){var e=this;return this.net.get("/user/get/history").pipe(n.tap((function(t){e.historyItems.next(t)}),(function(t){"Unauthorized"===(null==t?void 0:t.type)&&e.deleteAuthToken()})))},e.prototype.getHistoryTransactions=function(e,t,r){var s=this;return void 0===e&&(e="local"),void 0===t&&(t=15),void 0===r&&(r=0),this.net.get("/bonus/transactions?bonussystem="+e+"&limit="+t+"&number="+r).pipe(n.tap((function(e){s.historyTransactions.next(e)}),(function(){})))},e.prototype.updateProfile=function(e){var t=this;return this.net.post("/user/set/user-info",{user:e}).pipe(n.tap((function(e){t.user.next(e.user)}),(function(){})))},e.prototype.getAddresses=function(){var e=this;return this.addresses?this.addresses:this.net.get("/user/get/location").pipe(n.switchMap((function(t){return e.addresses=new s.BehaviorSubject(t),e.addresses})))},e.prototype.addAddress=function(e){var t=this;return this.net.post("/user/add/location",e).pipe(n.switchMap((function(e){return t.addresses.next(e),t.addresses})))},e.prototype.deleteAddress=function(e){var t=this;return this.net.post("/user/remove/location",{id:e.id,street:e.street,home:e.home}).pipe(n.tap((function(e){t.addresses.next(e)}),(function(){})))},e.prototype.signUp=function(e){return this.net.post("/signup",e).pipe(n.tap((function(){}),(function(){})))},e.prototype.signOut=function(){return this.deleteAuthToken()},e.prototype.getBonuses=function(){var e=this;return this.bonusSystems?this.bonusSystems:this.net.post("/bonus/get",{}).pipe(n.switchMap((function(t){return e.bonusSystems=new s.BehaviorSubject(t),e.bonusSystems})))},e.prototype.resetPassword=function(e){return this.net.post("/reset",e).pipe(n.tap((function(){}),(function(){})))},e.prototype.resetPasswordCode=function(e){return this.net.post("/code",e).pipe(n.tap((function(){}),(function(){})))},e.prototype.getFavorites=function(){var e=this;return this.favorites?this.favorites:this.net.get("/user/get/favorites").pipe(n.switchMap((function(t){return console.info("getFavorites result",t),e.favorites=new s.BehaviorSubject(t),e.favorites})))},e.prototype.addDishToFavorites=function(e){var t=this;return this.net.post("/user/add/favorites ",{dishId:e.id}).pipe(n.tap((function(e){return t.favorites.next(e)}),(function(){})))},e.prototype.removeDishFromFavorites=function(e){var t=this;return this.net.post("/user/remove/favorites ",{dishId:e.id}).pipe(n.tap((function(r){console.info("Было=>>>",t.favorites.getValue().length);var s=t.favorites.getValue().filter((function(t){return t.id!=e.id}));console.info("Стало=>>>",s.length),t.favorites.next(r)}),(function(){})))},e.prototype.userProfile=function(){var e=this;return this.user?this.user:this.getProfile().pipe(n.switchMap((function(){return e.getFavorites()})),n.switchMap((function(){return e.getAddresses()})),n.switchMap((function(){return e.getBonuses()})),n.switchMap((function(){return e.user})))},e.prototype.userIsLoggedIn=function(){return this.isLoggedIn},e.prototype.userFavorites=function(){return this.favorites?this.favorites.asObservable():s.of([])},e.prototype.userAddresses=function(){return this.addresses?this.addresses.asObservable():s.of([])},e.prototype.userHistory=function(){return this.historyItems?this.historyItems.asObservable():s.of([])},e.prototype.userTransactionsHistory=function(){return this.historyTransactions?this.historyTransactions.asObservable():s.of([])},e.prototype.getAuthToken=function(){return this.authToken},e.prototype.setAuthToken=function(e){this.rememberMe&&localStorage.setItem(o,e),this.authToken=e,this.isLoggedIn.next(!0)},e.prototype.deleteAuthToken=function(){this.authToken=null,localStorage.removeItem(o),this.isLoggedIn.next(!1)},e.prototype.saveAvatar=function(e){var t=this,r=new FormData;return r.append("avatar",e,e.name),this.net.post("/user/avatar/upload",r,!0,{headers:{"Content-Type":"multipart/form-data"}}).pipe(n.tap((function(e){return t.user.next(e.user)}),(function(){})))},e}();u.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new u(t.ɵɵinject(r.NetService))},token:u,providedIn:"root"}),u.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],u.ctorParameters=function(){return[{type:r.NetService}]};var c=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={name:this.name,phone:this.preparePhone(this.phone),email:this.email,password:this.password,captcha:this.captcha};this.ngRestoUserService.signUp(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e.prototype.preparePhone=function(e){return(e="+"+e.replace(/[^0-9]/gim,"")).replace("+8","")},e}();c.decorators=[{type:t.Directive,args:[{selector:"[rstSignUp]"}]}],c.ctorParameters=function(){return[{type:u}]},c.propDecorators={name:[{type:t.Input}],phone:[{type:t.Input}],email:[{type:t.Input}],password:[{type:t.Input}],captcha:[{type:t.Input}],success:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var p=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={phone:this.preparePhone(this.phone),password:this.password,captcha:this.captcha};this.ngRestoUserService.signIn(t,this.rememberMe).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e.prototype.preparePhone=function(e){return(e="+"+e.replace(/[^0-9]/gim,"")).replace("+8","")},e}();p.decorators=[{type:t.Directive,args:[{selector:"[rstSignIn]"}]}],p.ctorParameters=function(){return[{type:u}]},p.propDecorators={phone:[{type:t.Input}],password:[{type:t.Input}],captcha:[{type:t.Input}],rememberMe:[{type:t.Input}],success:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var a=function(){function e(e){this.ngRestoUserService=e}return e.prototype.onClick=function(){this.ngRestoUserService.signOut()},e}();a.decorators=[{type:t.Directive,args:[{selector:"[rstSignOut]"}]}],a.ctorParameters=function(){return[{type:u}]},a.propDecorators={onClick:[{type:t.HostListener,args:["click"]}]};var h=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={phone:this.phone,captcha:this.captcha};this.ngRestoUserService.resetPassword(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();h.decorators=[{type:t.Directive,args:[{selector:"[rstResetPassword]"}]}],h.ctorParameters=function(){return[{type:u}]},h.propDecorators={phone:[{type:t.Input}],captcha:[{type:t.Input}],success:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var d=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={userId:this.userId,code:this.code,password:this.password};this.ngRestoUserService.resetPasswordCode(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();d.decorators=[{type:t.Directive,args:[{selector:"[rstResetPasswordCode]"}]}],d.ctorParameters=function(){return[{type:u}]},d.propDecorators={userId:[{type:t.Input}],code:[{type:t.Input}],password:[{type:t.Input}],success:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var f=function(e,t,r){var s=this;this.renderer=e,this.el=t,this.ngRestoUserService=r;var n=0;this.ngRestoUserService.getBonuses().subscribe((function(e){for(var t in e){var r=e[t];"active"==r.state&&(n+=r.balance)}s.amount=""+n,s.renderer.setProperty(s.el.nativeElement,"innerHTML",s.amount)}))};f.decorators=[{type:t.Directive,args:[{selector:"[rstBalance]"}]}],f.ctorParameters=function(){return[{type:t.Renderer2},{type:t.ElementRef},{type:u}]};var v=function(){function e(e,r,s){this.ngRestoUserService=e,this.element=r,this.renderer=s,this.change=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.ngOnDestroy=function(){[this.change,this.error].forEach((function(e){return e.complete()}))},e.prototype.ngOnInit=function(){var e=this;this.ngRestoUserService.userFavorites().subscribe((function(t){e.inFavorites=t.find((function(t){return t.id==e.dish.id})),e.inFavorites?e.renderer.addClass(e.element.nativeElement,"selected"):e.renderer.removeClass(e.element.nativeElement,"selected")})),this.ngRestoUserService.userIsLoggedIn().subscribe((function(t){return e.isLoggedIn=t}))},e.prototype.onClick=function(){this.inFavorites?this.removeDishFromFavorites():this.addDishToFavorites()},e.prototype.addDishToFavorites=function(){var e=this;this.ngRestoUserService.addDishToFavorites(this.dish).subscribe((function(){e.change.emit(!0),e.renderer.addClass(e.element.nativeElement,"selected")}),(function(t){return e.error.emit(t)}))},e.prototype.removeDishFromFavorites=function(){var e=this,t=this.ngRestoUserService.removeDishFromFavorites(this.dish).subscribe((function(){e.change.emit(!1),e.renderer.removeClass(e.element.nativeElement,"selected")}),(function(t){return e.error.emit(t)}),(function(){return t.unsubscribe()}))},e}();v.decorators=[{type:t.Directive,args:[{selector:"[rstToggleDishToFavorites]"}]}],v.ctorParameters=function(){return[{type:u},{type:t.ElementRef},{type:t.Renderer2}]},v.propDecorators={dish:[{type:t.Input}],change:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var y=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={name:this.name,email:this.email,additionalInfo:this.additionalInfo,birthday:this.birthday?i.formatDate(this.birthday,"yyyy-MM-dd","en"):this.birthday};this.ngRestoUserService.updateProfile(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();y.decorators=[{type:t.Directive,args:[{selector:"[rstUpdateProfile]"}]}],y.ctorParameters=function(){return[{type:u}]},y.propDecorators={name:[{type:t.Input}],phone:[{type:t.Input}],email:[{type:t.Input}],additionalInfo:[{type:t.Input}],birthday:[{type:t.Input}],success:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var l=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this;if(this.street)if(this.streetId)if(this.home)var t={street:this.street,streetId:this.streetId,home:this.home,name:this.name||"",housing:this.housing||"",index:this.index||"",entrance:this.entrance||"",floor:this.floor||"",apartment:this.apartment||"",doorphone:this.doorphone||""},r=this.ngRestoUserService.addAddress(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}),(function(){return r.unsubscribe()}));else this.error.emit("Необходимо указать номер дома");else this.error.emit("Необходимо указать streetId");else this.error.emit("Необходимо указать улицу")},e}();l.decorators=[{type:t.Directive,args:[{selector:"[rstAddAddress]"}]}],l.ctorParameters=function(){return[{type:u}]},l.propDecorators={street:[{type:t.Input}],streetId:[{type:t.Input}],home:[{type:t.Input}],name:[{type:t.Input}],housing:[{type:t.Input}],index:[{type:t.Input}],entrance:[{type:t.Input}],floor:[{type:t.Input}],apartment:[{type:t.Input}],doorphone:[{type:t.Input}],success:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var g=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this;this.ngRestoUserService.deleteAddress(this.address).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();g.decorators=[{type:t.Directive,args:[{selector:"[rstDeleteAddress]"}]}],g.ctorParameters=function(){return[{type:u}]},g.propDecorators={address:[{type:t.Input}],success:[{type:t.Output}],error:[{type:t.Output}],onClick:[{type:t.HostListener,args:["click"]}]};var m=function(){};m.decorators=[{type:t.NgModule,args:[{imports:[],providers:[],declarations:[c,p,a,h,d,f,v,y,l,g],exports:[c,p,a,h,d,f,v,y,l,g]}]}],e.AddAddressDirective=l,e.BalanceDirective=f,e.DeleteAddressDirective=g,e.NgRestoUserService=u,e.NgUserModule=m,e.ResetPasswordCodeDirective=d,e.ResetPasswordDirective=h,e.SignInDirective=p,e.SignOutDirective=a,e.SignUpDirective=c,e.ToggleDishToFavoritesDirective=v,e.UpdateProfileDirective=y,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=webresto-ng-user.umd.min.js.map