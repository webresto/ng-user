!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("@webresto/ng-core"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("@webresto/ng-user",["exports","@angular/core","rxjs","rxjs/operators","@webresto/ng-core","@angular/common/http"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).webresto=e.webresto||{},e.webresto["ng-user"]={}),e.ng.core,e.rxjs,e.rxjs.operators,e.i1,e.ng.common.http)}(this,(function(e,t,r,n,s,i){"use strict";var o="gf:tkn:v2",c=function(){function e(e,t){var n=this;this.net=e,this.eventer=t,this.rememberMe=!1,this.user=new r.BehaviorSubject({}),this.isLoggedIn=new r.BehaviorSubject(!1),this.favorites=new r.BehaviorSubject([]),this.addresses=new r.BehaviorSubject([]),this.historyItems=new r.BehaviorSubject([]),this.historyTransactions=new r.BehaviorSubject([]),this.bonusSystems=new r.BehaviorSubject([]),this.authToken=localStorage.getItem(o),this.authToken&&this.isLoggedIn.next(!0),this.isLoggedIn.subscribe((function(e){e&&setTimeout((function(){n.getFavorites().subscribe(),n.getProfile().subscribe(),n.getAddresses().subscribe(),n.getBonuses().subscribe(),n.getHistory().subscribe()}),500)})),this.eventer.getMessageEmitter().subscribe((function(e){switch(e.type){case"Unauthorized":n.deleteAuthToken()}}))}return e.prototype.signIn=function(e,t){var r=this;return void 0===t&&(t=!1),this.rememberMe=t,this.net.post("/signin",e).pipe(n.tap((function(e){r.setAuthToken(e.token,!1),r.user.next(e.user),r.eventer.emitMessageEvent(new s.EventMessage("success","Успех","Успешно авторизирован"))}),(function(e){return r.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.getProfile=function(){var e=this;return this.net.get("/user/get/user-info").pipe(n.tap((function(t){e.user.next(t)}),(function(t){return e.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",t))})))},e.prototype.getHistory=function(){var e=this;return this.net.get("/user/get/history").pipe(n.tap((function(t){e.historyItems.next(t)}),(function(t){return e.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",t))})))},e.prototype.getHistoryTransactions=function(e,t,r){var i=this;return void 0===e&&(e="local"),void 0===t&&(t=15),void 0===r&&(r=0),this.net.get("/bonus/transactions?bonussystem="+e+"&limit="+t+"&number="+r).pipe(n.tap((function(e){i.historyTransactions.next(e)}),(function(e){return i.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.updateProfile=function(e){var t=this;return this.net.post("/user/set/user-info",{user:e}).pipe(n.tap((function(e){t.user.next(e)}),(function(e){return t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.getAddresses=function(){var e=this;return this.net.get("/user/get/location").pipe(n.tap((function(t){e.addresses.next(t)}),(function(t){return e.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",t))})))},e.prototype.addAddress=function(e){var t=this;return this.net.post("/user/add/location",e).pipe(n.tap((function(e){t.addresses.next(e)}),(function(e){return t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.deleteAddress=function(e){var t=this,r={id:e.id,street:e.street,home:e.home};return this.net.post("/user/remove/location",r).pipe(n.tap((function(e){t.addresses.next(e)}),(function(e){return t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.signUp=function(e){var t=this;return this.net.post("/signup",e).pipe(n.tap((function(e){t.eventer.emitMessageEvent(new s.EventMessage("success","Регистрация","Ваш пароль был отправлен на указанный номер телефона"))}),(function(e){t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.signOut=function(){return this.deleteAuthToken()},e.prototype.getBonuses=function(){var e=this;return this.net.post("/bonus/get",{}).pipe(n.tap((function(t){e.bonusSystems.next(t)}),(function(t){return e.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",t))})))},e.prototype.resetPassword=function(e){var t=this;return this.net.post("/reset",e).pipe(n.tap((function(e){}),(function(e){return t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.resetPasswordCode=function(e){var t=this;return this.net.post("/code",e).pipe(n.tap((function(e){}),(function(e){return t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.getFavorites=function(){var e=this;return this.net.get("/user/get/favorites ").pipe(n.tap((function(t){console.info("getFavorites result",t),e.favorites.next(t)}),(function(t){return e.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",t))})))},e.prototype.addDishToFavorites=function(e){var t=this,r={dishId:e.id};return this.net.post("/user/add/favorites ",r).pipe(n.tap((function(r){var n=t.favorites.getValue();n.push(e),t.favorites.next(n)}),(function(e){return t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.removeDishFromFavorites=function(e){var t=this,r={dishId:e.id};return this.net.post("/user/remove/favorites ",r).pipe(n.tap((function(r){console.info("Было=>>>",t.favorites.getValue().length);var n=t.favorites.getValue().filter((function(t){return t.id!=e.id}));console.info("Стало=>>>",n.length),t.favorites.next(n)}),(function(e){return t.eventer.emitMessageEvent(new s.EventMessage("error","Ошибка",e))})))},e.prototype.userProfile=function(){return this.user.pipe()},e.prototype.userIsLoggedIn=function(){return this.isLoggedIn.pipe()},e.prototype.userFavorites=function(){return this.favorites.pipe()},e.prototype.userAddresses=function(){return this.addresses.pipe()},e.prototype.userHistory=function(){return this.historyItems.pipe()},e.prototype.userTransactionsHistory=function(){return this.historyTransactions.pipe()},e.prototype.getAuthToken=function(){return this.authToken},e.prototype.setAuthToken=function(e,t){void 0===t&&(t=!0),this.rememberMe&&(localStorage.setItem(o,e),localStorage.removeItem("gf:login:phone")),this.authToken=e,this.isLoggedIn.next(!0)},e.prototype.deleteAuthToken=function(){this.authToken=void 0,localStorage.removeItem(o),localStorage.removeItem("gf:login:phone"),this.isLoggedIn.next(!1)},e}();c.ɵfac=function(e){return new(e||c)(t.ɵɵinject(s.NetService),t.ɵɵinject(s.EventerService))},c.ɵprov=t.ɵɵdefineInjectable({token:c,factory:c.ɵfac,providedIn:"root"});Object.create;Object.create;var u=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={name:this.name,phone:this.preparePhone(this.phone),email:this.email,password:this.password,captcha:this.captcha};this.ngRestoUserService.signUp(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e.prototype.preparePhone=function(e){return(e="+"+e.replace(/[^0-9]/gim,"")).replace("+8","")},e}();u.ɵfac=function(e){return new(e||u)(t.ɵɵdirectiveInject(c))},u.ɵdir=t.ɵɵdefineDirective({type:u,selectors:[["","appSignUp",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{name:"name",phone:"phone",email:"email",password:"password",captcha:"captcha"},outputs:{success:"success",error:"error"}});var a=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={phone:this.preparePhone(this.phone),password:this.password,captcha:this.captcha};this.ngRestoUserService.signIn(t,this.rememberMe).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e.prototype.preparePhone=function(e){return(e="+"+e.replace(/[^0-9]/gim,"")).replace("+8","")},e}();a.ɵfac=function(e){return new(e||a)(t.ɵɵdirectiveInject(c))},a.ɵdir=t.ɵɵdefineDirective({type:a,selectors:[["","appSignIn",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{phone:"phone",password:"password",captcha:"captcha",rememberMe:"rememberMe"},outputs:{success:"success",error:"error"}});var p=function(){function e(e){this.ngRestoUserService=e}return e.prototype.onClick=function(){this.ngRestoUserService.signOut()},e}();p.ɵfac=function(e){return new(e||p)(t.ɵɵdirectiveInject(c))},p.ɵdir=t.ɵɵdefineDirective({type:p,selectors:[["","appSignOut",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))}});var h=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={phone:this.phone,captcha:this.captcha};this.ngRestoUserService.resetPassword(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();h.ɵfac=function(e){return new(e||h)(t.ɵɵdirectiveInject(c))},h.ɵdir=t.ɵɵdefineDirective({type:h,selectors:[["","appResetPassword",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{phone:"phone",captcha:"captcha"},outputs:{success:"success",error:"error"}});var v=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={userId:this.userId,code:this.code,password:this.password};this.ngRestoUserService.resetPasswordCode(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();v.ɵfac=function(e){return new(e||v)(t.ɵɵdirectiveInject(c))},v.ɵdir=t.ɵɵdefineDirective({type:v,selectors:[["","appResetPasswordCode",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{userId:"userId",code:"code",password:"password"},outputs:{success:"success",error:"error"}});var d=function(e,t,r){var n=this;this.renderer=e,this.el=t,this.ngRestoUserService=r;var s=0;this.ngRestoUserService.getBonuses().subscribe((function(e){for(var t in e){var r=e[t];"active"==r.state&&(s+=r.balance)}n.amount=""+s,n.renderer.setProperty(n.el.nativeElement,"innerHTML",n.amount)}))};d.ɵfac=function(e){return new(e||d)(t.ɵɵdirectiveInject(t.Renderer2),t.ɵɵdirectiveInject(t.ElementRef),t.ɵɵdirectiveInject(c))},d.ɵdir=t.ɵɵdefineDirective({type:d,selectors:[["","appBalance",""]]});var f=function(){function e(e,r,n){this.ngRestoUserService=e,this.element=r,this.renderer=n,this.addedToFavorites=new t.EventEmitter,this.removedFromFavorites=new t.EventEmitter,this.change=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.ngOnInit=function(){var e=this;this.ngRestoUserService.userFavorites().subscribe((function(t){e.inFavorites=t.find((function(t){return t.id==e.dish.id})),e.inFavorites?e.renderer.addClass(e.element.nativeElement,"selected"):e.renderer.removeClass(e.element.nativeElement,"selected")})),this.ngRestoUserService.userIsLoggedIn().subscribe((function(t){return e.isLoggedIn=t}))},e.prototype.onClick=function(){this.inFavorites?this.removeDishFromFavorites():this.addDishToFavorites()},e.prototype.addDishToFavorites=function(){var e=this;this.ngRestoUserService.addDishToFavorites(this.dish).subscribe((function(){e.addedToFavorites.emit(),e.change.emit(!0),e.renderer.addClass(e.element.nativeElement,"selected")}),(function(t){return e.error.emit(t)}))},e.prototype.removeDishFromFavorites=function(){var e=this;this.ngRestoUserService.removeDishFromFavorites(this.dish).subscribe((function(){e.removedFromFavorites.emit(),e.change.emit(!1),e.renderer.removeClass(e.element.nativeElement,"selected")}),(function(t){return e.error.emit(t)}))},e}();f.ɵfac=function(e){return new(e||f)(t.ɵɵdirectiveInject(c),t.ɵɵdirectiveInject(t.ElementRef),t.ɵɵdirectiveInject(t.Renderer2))},f.ɵdir=t.ɵɵdefineDirective({type:f,selectors:[["","appToggleDishToFavorites",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{dish:"dish"},outputs:{addedToFavorites:"addedToFavorites",removedFromFavorites:"removedFromFavorites",change:"change",error:"error"}});var g=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this,t={name:this.name,email:this.email};this.ngRestoUserService.updateProfile(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();g.ɵfac=function(e){return new(e||g)(t.ɵɵdirectiveInject(c))},g.ɵdir=t.ɵɵdefineDirective({type:g,selectors:[["","appUpdateProfile",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{name:"name",phone:"phone",email:"email"},outputs:{success:"success",error:"error"}});var m=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this;if(this.street)if(this.home){var t={street:this.street,home:this.home,name:this.name||"",housing:this.housing||"",index:this.index||"",entrance:this.entrance||"",floor:this.floor||"",apartment:this.apartment||"",doorphone:this.doorphone||""};this.ngRestoUserService.addAddress(t).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))}else this.error.emit("Необходимо указать номер дома");else this.error.emit("Необходимо указать улицу")},e}();m.ɵfac=function(e){return new(e||m)(t.ɵɵdirectiveInject(c))},m.ɵdir=t.ɵɵdefineDirective({type:m,selectors:[["","appAddAddress",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{street:"street",home:"home",name:"name",housing:"housing",index:"index",entrance:"entrance",floor:"floor",apartment:"apartment",doorphone:"doorphone"},outputs:{success:"success",error:"error"}});var l=function(){function e(e){this.ngRestoUserService=e,this.success=new t.EventEmitter,this.error=new t.EventEmitter}return e.prototype.onClick=function(){var e=this;this.ngRestoUserService.deleteAddress(this.address).subscribe((function(){return e.success.emit(!0)}),(function(t){return e.error.emit(t)}))},e}();l.ɵfac=function(e){return new(e||l)(t.ɵɵdirectiveInject(c))},l.ɵdir=t.ɵɵdefineDirective({type:l,selectors:[["","appDeleteAddress",""]],hostBindings:function(e,r){1&e&&t.ɵɵlistener("click",(function(){return r.onClick()}))},inputs:{address:"address"},outputs:{success:"success",error:"error"}});var w=function(){};w.ɵmod=t.ɵɵdefineNgModule({type:w}),w.ɵinj=t.ɵɵdefineInjector({factory:function(e){return new(e||w)},providers:[],imports:[[]]}),("undefined"==typeof ngJitMode||ngJitMode)&&t.ɵɵsetNgModuleScope(w,{declarations:[u,a,p,h,v,d,f,g,m,l],exports:[u,a,p,h,v,d,f,g,m,l]});var E=function(){function e(e){this.userService=e}return e.prototype.intercept=function(e,t){console.info("AuthInterceptor",e);var r=this.userService.getAuthToken();if(r){var n=e.clone({headers:e.headers.set("Authorization","JWT "+r)});return t.handle(n)}return t.handle(e)},e}();E.ɵfac=function(e){return new(e||E)(t.ɵɵinject(c))},E.ɵprov=t.ɵɵdefineInjectable({token:E,factory:E.ɵfac});var y=[{provide:i.HTTP_INTERCEPTORS,useClass:E,multi:!0}];e.AddAddressDirective=m,e.AuthInterceptor=E,e.BalanceDirective=d,e.DeleteAddressDirective=l,e.NgRestoUserService=c,e.NgUserModule=w,e.ResetPasswordCodeDirective=v,e.ResetPasswordDirective=h,e.SignInDirective=a,e.SignOutDirective=p,e.SignUpDirective=u,e.ToggleDishToFavoritesDirective=f,e.UpdateProfileDirective=g,e.ngUserHttpInterceptorProviders=y,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=webresto-ng-user.umd.min.js.map