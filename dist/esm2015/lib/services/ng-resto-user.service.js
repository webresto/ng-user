import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { filter, switchMap, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@webresto/ng-core";
const LS_TOKEN_NAME = 'gf:tkn:v2';
export class NgRestoUserService {
    constructor(
    //private restoStorageService:RestoStorageService,
    net, eventer) {
        this.net = net;
        this.eventer = eventer;
        this.authToken = localStorage.getItem(LS_TOKEN_NAME);
        this.rememberMe = false;
        this.user = new BehaviorSubject({});
        this.isLoggedIn = new BehaviorSubject(this.authToken ? true : false);
        this.favorites = new BehaviorSubject([]);
        this.addresses = new BehaviorSubject([]);
        this.historyItems = new BehaviorSubject([]);
        this.historyTransactions = new BehaviorSubject([]);
        this.bonusSystems = new BehaviorSubject([]);
        this.isLoggedSubscription = this.isLoggedIn.pipe(filter(isLoggedIn => isLoggedIn === true), switchMap(() => this.getFavorites()), switchMap(() => this.getProfile()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses()), switchMap(() => this.getHistory())).subscribe(() => { }, () => { }, () => this.isLoggedSubscription.unsubscribe());
    }
    signIn(data, rememberMe = false) {
        this.rememberMe = rememberMe;
        return this.net.post('/signin', data).pipe(tap((result) => {
            this.setAuthToken(result.token);
            this.user.next(result.user);
            this.isLoggedIn.next(true);
        }, () => { }));
    }
    getProfile() {
        return this.net.get('/user/get/user-info').pipe(tap((result) => {
            this.user.next(result);
        }, () => { }));
    }
    getHistory() {
        return this.net.get('/user/get/history').pipe(tap((historyItems) => {
            this.historyItems.next(historyItems);
        }, error => {
            if ((error === null || error === void 0 ? void 0 : error.type) === "Unauthorized") {
                this.deleteAuthToken();
            }
            ;
        }));
    }
    getHistoryTransactions(bonusSystem = "local", limit = 15, set = 0) {
        return this.net.get(`/bonus/transactions?bonussystem=${bonusSystem}&limit=${limit}&number=${set}`).pipe(tap((transactions) => {
            this.historyTransactions.next(transactions);
        }, () => { }));
    }
    updateProfile(data) {
        return this.net.post('/user/set/user-info', {
            user: data
        }).pipe(tap((result) => {
            this.user.next(result);
        }, () => { }));
    }
    getAddresses() {
        return this.net.get('/user/get/location').pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    addAddress(address) {
        return this.net.post('/user/add/location', address).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    deleteAddress(address) {
        var reqBody = {
            id: address.id,
            street: address.street,
            home: address.home
        };
        return this.net.post('/user/remove/location', reqBody).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    signUp(data) {
        return this.net.post('/signup', data).pipe(tap((result) => {
            //this.setAuthToken(result.token, false);
            //this.user.next(result.user);
        }, () => { }));
    }
    signOut() {
        return this.deleteAuthToken();
    }
    getBonuses() {
        return this.net.post('/bonus/get', {}).pipe(tap(result => this.bonusSystems.next(result), () => { }));
    }
    resetPassword(data) {
        return this.net.post('/reset', data).pipe(tap(() => { }, () => { }));
    }
    resetPasswordCode(data) {
        return this.net.post('/code', data).pipe(tap(() => { }, () => { }));
    }
    getFavorites() {
        return this.net.get('/user/get/favorites').pipe(tap(result => {
            console.info('getFavorites result', result);
            this.favorites.next(result);
        }, () => { }));
    }
    addDishToFavorites(dish) {
        let data = {
            dishId: dish.id
        };
        return this.net.post('/user/add/favorites ', data).pipe(tap(result => {
            let favoritesUpdated = this.favorites.getValue();
            favoritesUpdated.push(dish);
            this.favorites.next(result);
        }, () => { }));
    }
    removeDishFromFavorites(dish) {
        let data = {
            dishId: dish.id
        };
        return this.net.post('/user/remove/favorites ', data).pipe(tap((result) => {
            console.info('Было=>>>', this.favorites.getValue().length);
            let favoritesUpdated = this.favorites
                .getValue()
                .filter(item => item.id != dish.id);
            console.info('Стало=>>>', favoritesUpdated.length);
            this.favorites.next(result);
        }, () => { }));
    }
    userProfile() {
        return this.user;
    }
    userIsLoggedIn() {
        return this.isLoggedIn;
    }
    userFavorites() {
        return this.favorites.pipe();
    }
    userAddresses() {
        return this.addresses.pipe();
    }
    userHistory() {
        return this.historyItems.pipe();
    }
    userTransactionsHistory() {
        return this.historyTransactions.pipe();
    }
    getAuthToken() {
        return this.authToken;
    }
    setAuthToken(authToken) {
        if (this.rememberMe) {
            localStorage.setItem(LS_TOKEN_NAME, authToken);
        }
        ;
        this.authToken = authToken;
        this.isLoggedIn.next(true);
        /*if(updateProfile) {
          this.getProfile().subscribe();
          this.getFavorites().subscribe();
          this.getAddresses().subscribe();
          this.getHistory().subscribe();
        }*/
    }
    deleteAuthToken() {
        this.authToken = null;
        localStorage.removeItem(LS_TOKEN_NAME);
        this.isLoggedIn.next(false);
    }
    saveAvatar(avatar) {
        const data = new FormData();
        data.append('avatar', avatar, avatar.name);
        return this.net.post('/user/avatar/upload', data, true, {
            headers: { 'Content-Type': 'multipart/form-data' },
        }).pipe(tap(result => this.user.next(result.user), () => { }));
    }
}
NgRestoUserService.ɵfac = function NgRestoUserService_Factory(t) { return new (t || NgRestoUserService)(i0.ɵɵinject(i1.NetService), i0.ɵɵinject(i1.EventerService)); };
NgRestoUserService.ɵprov = i0.ɵɵdefineInjectable({ token: NgRestoUserService, factory: NgRestoUserService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(NgRestoUserService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.NetService }, { type: i1.EventerService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcmVzdG8tdXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9uZy1yZXN0by11c2VyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFTeEQsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDO0FBS2xDLE1BQU0sT0FBTyxrQkFBa0I7SUFvQjdCO0lBQ0Usa0RBQWtEO0lBQzFDLEdBQWUsRUFDZixPQUF1QjtRQUR2QixRQUFHLEdBQUgsR0FBRyxDQUFZO1FBQ2YsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFyQnpCLGNBQVMsR0FBVyxZQUFZLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3hELGVBQVUsR0FBWSxLQUFLLENBQUM7UUFDNUIsU0FBSSxHQUF5QixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNyRCxlQUFVLEdBQTZCLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkcsY0FBUyxHQUEyQixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1RCxjQUFTLEdBQStCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2hFLGlCQUFZLEdBQTJCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELHdCQUFtQixHQUEyQixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0RSxpQkFBWSxHQUEyQixJQUFJLGVBQWUsQ0FBUSxFQUFFLENBQUMs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Q29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBmaWx0ZXIsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBFdmVudGVyU2VydmljZSwgRXZlbnRNZXNzYWdlLCBOZXRTZXJ2aWNlIH0gZnJvbSAnQHdlYnJlc3RvL25nLWNvcmUnO1xyXG5pbXBvcnQge1xyXG4gIEFkZHJlc3MsIFNpZ25JblJlcXVlc3REYXRhLCBTaWduSW5SZXNwb25zZURhdGEsIFVzZXIsIFVwZGF0ZVByb2ZpbGVSZXF1ZXN0RGF0YSxcclxuICBVcGRhdGVQcm9maWxlUmVzcG9uc2VEYXRhLCBBZGRBZGRyZXNzUmVxdWVzdERhdGEsIFJlbW92ZUFkZHJlc3NSZXF1ZXN0RGF0YSwgU2lnblVwUmVxdWVzdERhdGEsXHJcbiAgU2lnblVwUmVzcG9uc2VEYXRhLCBSZXNldFBhc3N3b3JkUmVxdWVzdERhdGEsIFJlc2V0UGFzc3dvcmRSZXNwb25zZURhdGEsIFJlc2V0UGFzc3dvcmRDb2RlUmVxdWVzdERhdGEsXHJcbiAgUmVzZXRQYXNzd29yZENvZGVSZXNwb25zZURhdGEsIEFkZERpc2hUb0Zhdm9yaXRlc1JlcXVlc3REYXRhLCBSZW1vdmVEaXNoRnJvbUZhdm9yaXRlc1JlcXVlc3REYXRhXHJcbn0gZnJvbSAnLi4vLi4vbW9kZWxzJztcclxuXHJcbmNvbnN0IExTX1RPS0VOX05BTUUgPSAnZ2Y6dGtuOnYyJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIE5nUmVzdG9Vc2VyU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgYXV0aFRva2VuOiBzdHJpbmcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19UT0tFTl9OQU1FKTtcclxuICBwcml2YXRlIHJlbWVtYmVyTWU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBwcml2YXRlIHVzZXI6IEJlaGF2aW9yU3ViamVjdDxhbnk+ID0gbmV3IEJlaGF2aW9yU3ViamVjdCh7fSk7XHJcbiAgcHJpdmF0ZSBpc0xvZ2dlZEluOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRoaXMuYXV0aFRva2VuID8gdHJ1ZSA6IGZhbHNlKTtcclxuICBwcml2YXRlIGZhdm9yaXRlczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xyXG4gIHByaXZhdGUgYWRkcmVzc2VzOiBCZWhhdmlvclN1YmplY3Q8QWRkcmVzc1tdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xyXG4gIHByaXZhdGUgaGlzdG9yeUl0ZW1zOiBCZWhhdmlvclN1YmplY3Q8YW55W10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XHJcbiAgcHJpdmF0ZSBoaXN0b3J5VHJhbnNhY3Rpb25zOiBCZWhhdmlvclN1YmplY3Q8YW55W10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XHJcbiAgcHJpdmF0ZSBib251c1N5c3RlbXM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueVtdPihbXSk7XHJcbiAgcHJpdmF0ZSBpc0xvZ2dlZFN1YnNjcmlwdGlvbiA9IHRoaXMuaXNMb2dnZWRJbi5waXBlKFxyXG4gICAgZmlsdGVyKGlzTG9nZ2VkSW4gPT4gaXNMb2dnZWRJbiA9PT0gdHJ1ZSksXHJcbiAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRGYXZvcml0ZXMoKSksXHJcbiAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRQcm9maWxlKCkpLFxyXG4gICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0QWRkcmVzc2VzKCkpLFxyXG4gICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0Qm9udXNlcygpKSxcclxuICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEhpc3RvcnkoKSlcclxuICApLnN1YnNjcmliZSgoKSA9PiB7IH0sICgpID0+IHsgfSwgKCkgPT4gdGhpcy5pc0xvZ2dlZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICAvL3ByaXZhdGUgcmVzdG9TdG9yYWdlU2VydmljZTpSZXN0b1N0b3JhZ2VTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBuZXQ6IE5ldFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGV2ZW50ZXI6IEV2ZW50ZXJTZXJ2aWNlXHJcbiAgKSB7IH1cclxuXHJcbiAgc2lnbkluKGRhdGE6IFNpZ25JblJlcXVlc3REYXRhLCByZW1lbWJlck1lOiBib29sZWFuID0gZmFsc2UpIHtcclxuXHJcbiAgICB0aGlzLnJlbWVtYmVyTWUgPSByZW1lbWJlck1lO1xyXG5cclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvc2lnbmluJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChyZXN1bHQ6IFNpZ25JblJlc3BvbnNlRGF0YSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zZXRBdXRoVG9rZW4ocmVzdWx0LnRva2VuKTtcclxuICAgICAgICAgIHRoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcclxuICAgICAgICAgIHRoaXMuaXNMb2dnZWRJbi5uZXh0KHRydWUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcblxyXG4gIH1cclxuXHJcbiAgZ2V0UHJvZmlsZSgpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoJy91c2VyL2dldC91c2VyLWluZm8nKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKHJlc3VsdDogVXNlcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy51c2VyLm5leHQocmVzdWx0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0SGlzdG9yeSgpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoJy91c2VyL2dldC9oaXN0b3J5JykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChoaXN0b3J5SXRlbXMpID0+IHtcclxuICAgICAgICAgIHRoaXMuaGlzdG9yeUl0ZW1zLm5leHQoaGlzdG9yeUl0ZW1zKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVycm9yID0+IHtcclxuICAgICAgICAgIGlmIChlcnJvcj8udHlwZSA9PT0gXCJVbmF1dGhvcml6ZWRcIikge1xyXG4gICAgICAgICAgICB0aGlzLmRlbGV0ZUF1dGhUb2tlbigpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGdldEhpc3RvcnlUcmFuc2FjdGlvbnMoYm9udXNTeXN0ZW06IHN0cmluZyA9IFwibG9jYWxcIiwgbGltaXQ6IG51bWJlciA9IDE1LCBzZXQ6IG51bWJlciA9IDApIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoYC9ib251cy90cmFuc2FjdGlvbnM/Ym9udXNzeXN0ZW09JHtib251c1N5c3RlbX0mbGltaXQ9JHtsaW1pdH0mbnVtYmVyPSR7c2V0fWApLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAodHJhbnNhY3Rpb25zKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmhpc3RvcnlUcmFuc2FjdGlvbnMubmV4dCh0cmFuc2FjdGlvbnMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVQcm9maWxlKGRhdGE6IFVwZGF0ZVByb2ZpbGVSZXF1ZXN0RGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL3NldC91c2VyLWluZm8nLCB7XHJcbiAgICAgIHVzZXI6IGRhdGFcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAocmVzdWx0OiBVcGRhdGVQcm9maWxlUmVzcG9uc2VEYXRhKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnVzZXIubmV4dChyZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgIClcclxuICB9XHJcblxyXG4gIGdldEFkZHJlc3NlcygpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoJy91c2VyL2dldC9sb2NhdGlvbicpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAoYWRkcmVzc2VzOiBBZGRyZXNzW10pID0+IHtcclxuICAgICAgICAgIHRoaXMuYWRkcmVzc2VzLm5leHQoYWRkcmVzc2VzKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgYWRkQWRkcmVzcyhhZGRyZXNzOiBBZGRBZGRyZXNzUmVxdWVzdERhdGEpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvdXNlci9hZGQvbG9jYXRpb24nLCBhZGRyZXNzKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKGFkZHJlc3NlczogQWRkcmVzc1tdKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmFkZHJlc3Nlcy5uZXh0KGFkZHJlc3Nlcyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGRlbGV0ZUFkZHJlc3MoYWRkcmVzczogQWRkcmVzcykge1xyXG4gICAgdmFyIHJlcUJvZHk6IFJlbW92ZUFkZHJlc3NSZXF1ZXN0RGF0YSA9IHtcclxuICAgICAgaWQ6IGFkZHJlc3MuaWQsXHJcbiAgICAgIHN0cmVldDogYWRkcmVzcy5zdHJlZXQsXHJcbiAgICAgIGhvbWU6IGFkZHJlc3MuaG9tZVxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvcmVtb3ZlL2xvY2F0aW9uJywgcmVxQm9keSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChhZGRyZXNzZXM6IEFkZHJlc3NbXSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5hZGRyZXNzZXMubmV4dChhZGRyZXNzZXMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzaWduVXAoZGF0YTogU2lnblVwUmVxdWVzdERhdGEpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvc2lnbnVwJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChyZXN1bHQpID0+IHtcclxuICAgICAgICAgIC8vdGhpcy5zZXRBdXRoVG9rZW4ocmVzdWx0LnRva2VuLCBmYWxzZSk7XHJcbiAgICAgICAgICAvL3RoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc2lnbk91dCgpIHtcclxuICAgIHJldHVybiB0aGlzLmRlbGV0ZUF1dGhUb2tlbigpO1xyXG4gIH1cclxuXHJcblxyXG4gIGdldEJvbnVzZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL2JvbnVzL2dldCcsIHt9KS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgcmVzdWx0ID0+IHRoaXMuYm9udXNTeXN0ZW1zLm5leHQocmVzdWx0KSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHJlc2V0UGFzc3dvcmQoZGF0YTogUmVzZXRQYXNzd29yZFJlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3Jlc2V0JywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHt9LFxyXG4gICAgICAgICgpID0+IHt9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXNldFBhc3N3b3JkQ29kZShkYXRhOiBSZXNldFBhc3N3b3JkQ29kZVJlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL2NvZGUnLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4geyAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7fVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcblxyXG4gIGdldEZhdm9yaXRlcygpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQ8YW55W10+KCcvdXNlci9nZXQvZmF2b3JpdGVzJykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmluZm8oJ2dldEZhdm9yaXRlcyByZXN1bHQnLCByZXN1bHQpO1xyXG4gICAgICAgICAgdGhpcy5mYXZvcml0ZXMubmV4dChyZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4ge31cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGFkZERpc2hUb0Zhdm9yaXRlcyhkaXNoOiBhbnkpIHtcclxuICAgIGxldCBkYXRhOiBBZGREaXNoVG9GYXZvcml0ZXNSZXF1ZXN0RGF0YSA9IHtcclxuICAgICAgZGlzaElkOiBkaXNoLmlkXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3Q8QWRkRGlzaFRvRmF2b3JpdGVzUmVxdWVzdERhdGEsIGFueVtdPignL3VzZXIvYWRkL2Zhdm9yaXRlcyAnLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgcmVzdWx0ID0+IHtcclxuICAgICAgICAgIGxldCBmYXZvcml0ZXNVcGRhdGVkOiBhbnlbXSA9IHRoaXMuZmF2b3JpdGVzLmdldFZhbHVlKCk7XHJcbiAgICAgICAgICBmYXZvcml0ZXNVcGRhdGVkLnB1c2goZGlzaCk7XHJcbiAgICAgICAgICB0aGlzLmZhdm9yaXRlcy5uZXh0KHJlc3VsdCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7fVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlRGlzaEZyb21GYXZvcml0ZXMoZGlzaDogYW55KSB7XHJcbiAgICBsZXQgZGF0YTogUmVtb3ZlRGlzaEZyb21GYXZvcml0ZXNSZXF1ZXN0RGF0YSA9IHtcclxuICAgICAgZGlzaElkOiBkaXNoLmlkXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL3JlbW92ZS9mYXZvcml0ZXMgJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChyZXN1bHQ6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmluZm8oJ9CR0YvQu9C+PT4+PicsIHRoaXMuZmF2b3JpdGVzLmdldFZhbHVlKCkubGVuZ3RoKTtcclxuICAgICAgICAgIGxldCBmYXZvcml0ZXNVcGRhdGVkOiBhbnlbXSA9IHRoaXMuZmF2b3JpdGVzXHJcbiAgICAgICAgICAgIC5nZXRWYWx1ZSgpXHJcbiAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLmlkICE9IGRpc2guaWQpO1xyXG4gICAgICAgICAgY29uc29sZS5pbmZvKCfQodGC0LDQu9C+PT4+PicsIGZhdm9yaXRlc1VwZGF0ZWQubGVuZ3RoKTtcclxuICAgICAgICAgIHRoaXMuZmF2b3JpdGVzLm5leHQocmVzdWx0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHt9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICB1c2VyUHJvZmlsZSgpOiBCZWhhdmlvclN1YmplY3Q8VXNlcj4ge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlcjtcclxuICB9XHJcblxyXG4gIHVzZXJJc0xvZ2dlZEluKCk6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5pc0xvZ2dlZEluO1xyXG4gIH1cclxuXHJcbiAgdXNlckZhdm9yaXRlcygpOiBPYnNlcnZhYmxlPGFueVtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5mYXZvcml0ZXMucGlwZSgpO1xyXG4gIH1cclxuXHJcbiAgdXNlckFkZHJlc3NlcygpOiBPYnNlcnZhYmxlPEFkZHJlc3NbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuYWRkcmVzc2VzLnBpcGUoKTtcclxuICB9XHJcblxyXG4gIHVzZXJIaXN0b3J5KCk6IE9ic2VydmFibGU8YW55W10+IHtcclxuICAgIHJldHVybiB0aGlzLmhpc3RvcnlJdGVtcy5waXBlKCk7XHJcbiAgfVxyXG4gIHVzZXJUcmFuc2FjdGlvbnNIaXN0b3J5KCk6IE9ic2VydmFibGU8YW55W10+IHtcclxuICAgIHJldHVybiB0aGlzLmhpc3RvcnlUcmFuc2FjdGlvbnMucGlwZSgpO1xyXG4gIH1cclxuXHJcbiAgZ2V0QXV0aFRva2VuKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5hdXRoVG9rZW47XHJcbiAgfVxyXG5cclxuICBzZXRBdXRoVG9rZW4oYXV0aFRva2VuOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLnJlbWVtYmVyTWUpIHtcclxuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oTFNfVE9LRU5fTkFNRSwgYXV0aFRva2VuKTtcclxuICAgIH07XHJcbiAgICB0aGlzLmF1dGhUb2tlbiA9IGF1dGhUb2tlbjtcclxuICAgIHRoaXMuaXNMb2dnZWRJbi5uZXh0KHRydWUpO1xyXG4gICAgLyppZih1cGRhdGVQcm9maWxlKSB7XHJcbiAgICAgIHRoaXMuZ2V0UHJvZmlsZSgpLnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLmdldEZhdm9yaXRlcygpLnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLmdldEFkZHJlc3NlcygpLnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLmdldEhpc3RvcnkoKS5zdWJzY3JpYmUoKTtcclxuICAgIH0qL1xyXG4gIH1cclxuXHJcbiAgZGVsZXRlQXV0aFRva2VuKCk6IHZvaWQge1xyXG4gICAgdGhpcy5hdXRoVG9rZW4gPSBudWxsO1xyXG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oTFNfVE9LRU5fTkFNRSk7XHJcbiAgICB0aGlzLmlzTG9nZ2VkSW4ubmV4dChmYWxzZSk7XHJcbiAgfVxyXG5cclxuICBzYXZlQXZhdGFyKGF2YXRhcjogRmlsZSkge1xyXG4gICAgY29uc3QgZGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xyXG4gICAgZGF0YS5hcHBlbmQoJ2F2YXRhcicsIGF2YXRhciwgYXZhdGFyLm5hbWUpO1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL2F2YXRhci91cGxvYWQnLCBkYXRhLCB0cnVlLCB7XHJcbiAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdtdWx0aXBhcnQvZm9ybS1kYXRhJyB9LFxyXG4gICAgfSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIHJlc3VsdCA9PiB0aGlzLnVzZXIubmV4dChyZXN1bHQudXNlcikgICAgICAgICxcclxuICAgICAgICAoKSA9PiB7fVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=