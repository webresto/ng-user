import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { filter, switchMap, tap } from 'rxjs/operators';
import { NetService } from '@webresto/ng-core';
import * as i0 from "@angular/core";
import * as i1 from "@webresto/ng-core";
const LS_TOKEN_NAME = 'gf:tkn:v2';
export class NgRestoUserService {
    constructor(net) {
        this.net = net;
        this.authToken = localStorage.getItem(LS_TOKEN_NAME);
        this.rememberMe = false;
        this.user = new BehaviorSubject(null);
        this.isLoggedIn = new BehaviorSubject(this.authToken ? true : false);
        this.favorites = new BehaviorSubject([]);
        this.addresses = new BehaviorSubject([]);
        this.historyItems = new BehaviorSubject([]);
        this.historyTransactions = new BehaviorSubject([]);
        this.bonusSystems = new BehaviorSubject([]);
        const isLoggedSubscription = this.isLoggedIn.pipe(filter(isLoggedIn => !!isLoggedIn), switchMap(() => this.getFavorites()), switchMap(() => this.getProfile()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses())).subscribe(() => { }, () => { }, () => isLoggedSubscription.unsubscribe());
    }
    signIn(data, rememberMe = false) {
        this.rememberMe = rememberMe;
        return this.net.post('/signin', data).pipe(tap((result) => {
            this.setAuthToken(result.token);
            this.user.next(result.user);
            this.isLoggedIn.next(true);
        }, () => { }));
    }
    getProfile() {
        return this.net.get('/user/get/user-info').pipe(tap((result) => {
            this.user.next(result);
        }, () => { }));
    }
    getHistory() {
        return this.net.get('/user/get/history').pipe(tap((historyItems) => {
            this.historyItems.next(historyItems);
        }, error => {
            if ((error === null || error === void 0 ? void 0 : error.type) === "Unauthorized") {
                this.deleteAuthToken();
            }
            ;
        }));
    }
    getHistoryTransactions(bonusSystem = "local", limit = 15, set = 0) {
        return this.net.get(`/bonus/transactions?bonussystem=${bonusSystem}&limit=${limit}&number=${set}`).pipe(tap((transactions) => {
            this.historyTransactions.next(transactions);
        }, () => { }));
    }
    updateProfile(data) {
        return this.net.post('/user/set/user-info', {
            user: data
        }).pipe(tap((result) => {
            this.user.next(result.user);
        }, () => { }));
    }
    getAddresses() {
        return this.net.get('/user/get/location').pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    addAddress(address) {
        return this.net.post('/user/add/location', address).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    deleteAddress(address) {
        var reqBody = {
            id: address.id,
            street: address.street,
            home: address.home
        };
        return this.net.post('/user/remove/location', reqBody).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    signUp(data) {
        return this.net.post('/signup', data).pipe(tap((result) => {
            //this.setAuthToken(result.token, false);
            //this.user.next(result.user);
        }, () => { }));
    }
    signOut() {
        return this.deleteAuthToken();
    }
    getBonuses() {
        return this.net.post('/bonus/get', {}).pipe(tap(result => this.bonusSystems.next(result), () => { }));
    }
    resetPassword(data) {
        return this.net.post('/reset', data).pipe(tap(() => { }, () => { }));
    }
    resetPasswordCode(data) {
        return this.net.post('/code', data).pipe(tap(() => { }, () => { }));
    }
    getFavorites() {
        return this.net.get('/user/get/favorites').pipe(tap(result => {
            console.info('getFavorites result', result);
            this.favorites.next(result);
        }, () => { }));
    }
    addDishToFavorites(dish) {
        let data = {
            dishId: dish.id
        };
        return this.net.post('/user/add/favorites ', data).pipe(tap(result => {
            let favoritesUpdated = this.favorites.getValue();
            favoritesUpdated.push(dish);
            this.favorites.next(result);
        }, () => { }));
    }
    removeDishFromFavorites(dish) {
        let data = {
            dishId: dish.id
        };
        return this.net.post('/user/remove/favorites ', data).pipe(tap((result) => {
            console.info('Было=>>>', this.favorites.getValue().length);
            let favoritesUpdated = this.favorites
                .getValue()
                .filter(item => item.id != dish.id);
            console.info('Стало=>>>', favoritesUpdated.length);
            this.favorites.next(result);
        }, () => { }));
    }
    userProfile() {
        return !!this.user.value ? this.user : this.getProfile().pipe(switchMap(() => this.getProfile()), switchMap(() => this.getFavorites()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses()), switchMap(() => this.user));
    }
    userIsLoggedIn() {
        return this.isLoggedIn;
    }
    userFavorites() {
        return this.favorites.pipe();
    }
    userAddresses() {
        return this.addresses.pipe();
    }
    userHistory() {
        return this.historyItems.pipe();
    }
    userTransactionsHistory() {
        return this.historyTransactions.pipe();
    }
    getAuthToken() {
        return this.authToken;
    }
    setAuthToken(authToken) {
        if (this.rememberMe) {
            localStorage.setItem(LS_TOKEN_NAME, authToken);
        }
        ;
        this.authToken = authToken;
        this.isLoggedIn.next(true);
        /*if(updateProfile) {
          this.getProfile().subscribe();
          this.getFavorites().subscribe();
          this.getAddresses().subscribe();
          this.getHistory().subscribe();
        }*/
    }
    deleteAuthToken() {
        this.authToken = null;
        localStorage.removeItem(LS_TOKEN_NAME);
        this.isLoggedIn.next(false);
    }
    saveAvatar(avatar) {
        const data = new FormData();
        data.append('avatar', avatar, avatar.name);
        return this.net.post('/user/avatar/upload', data, true, {
            headers: { 'Content-Type': 'multipart/form-data' },
        }).pipe(tap(result => this.user.next(result.user), () => { }));
    }
}
NgRestoUserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NgRestoUserService_Factory() { return new NgRestoUserService(i0.ɵɵinject(i1.NetService)); }, token: NgRestoUserService, providedIn: "root" });
NgRestoUserService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
NgRestoUserService.ctorParameters = () => [
    { type: NetService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcmVzdG8tdXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uL3Byb2plY3RzL3dlYnJlc3RvL25nLXVzZXIvc3JjLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL25nLXJlc3RvLXVzZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7QUFRL0MsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDO0FBS2xDLE1BQU0sT0FBTyxrQkFBa0I7SUFZN0IsWUFBb0IsR0FBZTtRQUFmLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFWM0IsY0FBUyxHQUFXLFlBQVksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDeEQsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUM1QixTQUFJLEdBQXlCLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3ZELGVBQVUsR0FBNkIsSUFBSSxlQUFlLENBQVUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNuRyxjQUFTLEdBQTJCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVELGNBQVMsR0FBK0IsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDaEUsaUJBQVksR0FBMkIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDL0Qsd0JBQW1CLEdBQTJCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RFLGlCQUFZLEdBQTJCLElBQUksZUFBZSxD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QUksRUFBRSxJQUFJLEVBQUU7WUFDdEQsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLHFCQUFxQixFQUFFO1NBQ25ELENBQUMsQ0FBQyxJQUFJLENBQ0wsR0FBRyxDQUNELE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUNyQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQ1YsQ0FDRixDQUFDO0lBQ0osQ0FBQzs7OztZQS9SRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQVpRLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBmaWx0ZXIsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBOZXRTZXJ2aWNlIH0gZnJvbSAnQHdlYnJlc3RvL25nLWNvcmUnO1xyXG5pbXBvcnQge1xyXG4gIEFkZHJlc3MsIFNpZ25JblJlcXVlc3REYXRhLCBTaWduSW5SZXNwb25zZURhdGEsIFVzZXIsIFVwZGF0ZVByb2ZpbGVSZXF1ZXN0RGF0YSxcclxuICBVcGRhdGVQcm9maWxlUmVzcG9uc2VEYXRhLCBBZGRBZGRyZXNzUmVxdWVzdERhdGEsIFJlbW92ZUFkZHJlc3NSZXF1ZXN0RGF0YSwgU2lnblVwUmVxdWVzdERhdGEsXHJcbiAgUmVzZXRQYXNzd29yZFJlcXVlc3REYXRhLCBSZXNldFBhc3N3b3JkQ29kZVJlcXVlc3REYXRhLFxyXG4gIEFkZERpc2hUb0Zhdm9yaXRlc1JlcXVlc3REYXRhLCBSZW1vdmVEaXNoRnJvbUZhdm9yaXRlc1JlcXVlc3REYXRhXHJcbn0gZnJvbSAnLi4vLi4vbW9kZWxzJztcclxuXHJcbmNvbnN0IExTX1RPS0VOX05BTUUgPSAnZ2Y6dGtuOnYyJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIE5nUmVzdG9Vc2VyU2VydmljZSB7XHJcblxyXG4gIHByaXZhdGUgYXV0aFRva2VuOiBzdHJpbmcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19UT0tFTl9OQU1FKTtcclxuICBwcml2YXRlIHJlbWVtYmVyTWU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBwcml2YXRlIHVzZXI6IEJlaGF2aW9yU3ViamVjdDxhbnk+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcclxuICBwcml2YXRlIGlzTG9nZ2VkSW46IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odGhpcy5hdXRoVG9rZW4gPyB0cnVlIDogZmFsc2UpO1xyXG4gIHByaXZhdGUgZmF2b3JpdGVzOiBCZWhhdmlvclN1YmplY3Q8YW55W10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XHJcbiAgcHJpdmF0ZSBhZGRyZXNzZXM6IEJlaGF2aW9yU3ViamVjdDxBZGRyZXNzW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XHJcbiAgcHJpdmF0ZSBoaXN0b3J5SXRlbXM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuICBwcml2YXRlIGhpc3RvcnlUcmFuc2FjdGlvbnM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuICBwcml2YXRlIGJvbnVzU3lzdGVtczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55W10+KFtdKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuZXQ6IE5ldFNlcnZpY2UpIHtcclxuICAgIGNvbnN0IGlzTG9nZ2VkU3Vic2NyaXB0aW9uID0gdGhpcy5pc0xvZ2dlZEluLnBpcGUoXHJcbiAgICAgIGZpbHRlcihpc0xvZ2dlZEluID0+ICEhaXNMb2dnZWRJbiksXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEZhdm9yaXRlcygpKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0UHJvZmlsZSgpKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0QWRkcmVzc2VzKCkpLFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRCb251c2VzKCkpLFxyXG4gICAgKS5zdWJzY3JpYmUoKCkgPT4geyB9LCAoKSA9PiB7IH0sICgpID0+IGlzTG9nZ2VkU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzaWduSW4oZGF0YTogU2lnbkluUmVxdWVzdERhdGEsIHJlbWVtYmVyTWU6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG5cclxuICAgIHRoaXMucmVtZW1iZXJNZSA9IHJlbWVtYmVyTWU7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9zaWduaW4nLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKHJlc3VsdDogU2lnbkluUmVzcG9uc2VEYXRhKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNldEF1dGhUb2tlbihyZXN1bHQudG9rZW4pO1xyXG4gICAgICAgICAgdGhpcy51c2VyLm5leHQocmVzdWx0LnVzZXIpO1xyXG4gICAgICAgICAgdGhpcy5pc0xvZ2dlZEluLm5leHQodHJ1ZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuXHJcbiAgfVxyXG5cclxuICBnZXRQcm9maWxlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldCgnL3VzZXIvZ2V0L3VzZXItaW5mbycpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAocmVzdWx0OiBVc2VyKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnVzZXIubmV4dChyZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBnZXRIaXN0b3J5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldCgnL3VzZXIvZ2V0L2hpc3RvcnknKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKGhpc3RvcnlJdGVtcykgPT4ge1xyXG4gICAgICAgICAgdGhpcy5oaXN0b3J5SXRlbXMubmV4dChoaXN0b3J5SXRlbXMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgaWYgKGVycm9yPy50eXBlID09PSBcIlVuYXV0aG9yaXplZFwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlQXV0aFRva2VuKCk7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0SGlzdG9yeVRyYW5zYWN0aW9ucyhib251c1N5c3RlbTogc3RyaW5nID0gXCJsb2NhbFwiLCBsaW1pdDogbnVtYmVyID0gMTUsIHNldDogbnVtYmVyID0gMCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldChgL2JvbnVzL3RyYW5zYWN0aW9ucz9ib251c3N5c3RlbT0ke2JvbnVzU3lzdGVtfSZsaW1pdD0ke2xpbWl0fSZudW1iZXI9JHtzZXR9YCkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICh0cmFuc2FjdGlvbnMpID0+IHtcclxuICAgICAgICAgIHRoaXMuaGlzdG9yeVRyYW5zYWN0aW9ucy5uZXh0KHRyYW5zYWN0aW9ucyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHVwZGF0ZVByb2ZpbGUoZGF0YTogVXBkYXRlUHJvZmlsZVJlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvc2V0L3VzZXItaW5mbycsIHtcclxuICAgICAgdXNlcjogZGF0YVxyXG4gICAgfSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChyZXN1bHQ6IFVwZGF0ZVByb2ZpbGVSZXNwb25zZURhdGEpID0+IHtcclxuICAgICAgICAgIHRoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApXHJcbiAgfVxyXG5cclxuICBnZXRBZGRyZXNzZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQuZ2V0KCcvdXNlci9nZXQvbG9jYXRpb24nKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKGFkZHJlc3NlczogQWRkcmVzc1tdKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmFkZHJlc3Nlcy5uZXh0KGFkZHJlc3Nlcyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGFkZEFkZHJlc3MoYWRkcmVzczogQWRkQWRkcmVzc1JlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvYWRkL2xvY2F0aW9uJywgYWRkcmVzcykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChhZGRyZXNzZXM6IEFkZHJlc3NbXSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5hZGRyZXNzZXMubmV4dChhZGRyZXNzZXMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBkZWxldGVBZGRyZXNzKGFkZHJlc3M6IEFkZHJlc3MpIHtcclxuICAgIHZhciByZXFCb2R5OiBSZW1vdmVBZGRyZXNzUmVxdWVzdERhdGEgPSB7XHJcbiAgICAgIGlkOiBhZGRyZXNzLmlkLFxyXG4gICAgICBzdHJlZXQ6IGFkZHJlc3Muc3RyZWV0LFxyXG4gICAgICBob21lOiBhZGRyZXNzLmhvbWVcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL3JlbW92ZS9sb2NhdGlvbicsIHJlcUJvZHkpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAoYWRkcmVzc2VzOiBBZGRyZXNzW10pID0+IHtcclxuICAgICAgICAgIHRoaXMuYWRkcmVzc2VzLm5leHQoYWRkcmVzc2VzKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc2lnblVwKGRhdGE6IFNpZ25VcFJlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3NpZ251cCcsIGRhdGEpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAocmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAvL3RoaXMuc2V0QXV0aFRva2VuKHJlc3VsdC50b2tlbiwgZmFsc2UpO1xyXG4gICAgICAgICAgLy90aGlzLnVzZXIubmV4dChyZXN1bHQudXNlcik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHNpZ25PdXQoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5kZWxldGVBdXRoVG9rZW4oKTtcclxuICB9XHJcblxyXG5cclxuICBnZXRCb251c2VzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9ib251cy9nZXQnLCB7fSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIHJlc3VsdCA9PiB0aGlzLmJvbnVzU3lzdGVtcy5uZXh0KHJlc3VsdCksXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXNldFBhc3N3b3JkKGRhdGE6IFJlc2V0UGFzc3dvcmRSZXF1ZXN0RGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9yZXNldCcsIGRhdGEpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAoKSA9PiB7IH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXNldFBhc3N3b3JkQ29kZShkYXRhOiBSZXNldFBhc3N3b3JkQ29kZVJlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL2NvZGUnLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4geyB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcblxyXG4gIGdldEZhdm9yaXRlcygpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQ8YW55W10+KCcvdXNlci9nZXQvZmF2b3JpdGVzJykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmluZm8oJ2dldEZhdm9yaXRlcyByZXN1bHQnLCByZXN1bHQpO1xyXG4gICAgICAgICAgdGhpcy5mYXZvcml0ZXMubmV4dChyZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBhZGREaXNoVG9GYXZvcml0ZXMoZGlzaDogYW55KSB7XHJcbiAgICBsZXQgZGF0YTogQWRkRGlzaFRvRmF2b3JpdGVzUmVxdWVzdERhdGEgPSB7XHJcbiAgICAgIGRpc2hJZDogZGlzaC5pZFxyXG4gICAgfTtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0PEFkZERpc2hUb0Zhdm9yaXRlc1JlcXVlc3REYXRhLCBhbnlbXT4oJy91c2VyL2FkZC9mYXZvcml0ZXMgJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICBsZXQgZmF2b3JpdGVzVXBkYXRlZDogYW55W10gPSB0aGlzLmZhdm9yaXRlcy5nZXRWYWx1ZSgpO1xyXG4gICAgICAgICAgZmF2b3JpdGVzVXBkYXRlZC5wdXNoKGRpc2gpO1xyXG4gICAgICAgICAgdGhpcy5mYXZvcml0ZXMubmV4dChyZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVEaXNoRnJvbUZhdm9yaXRlcyhkaXNoOiBhbnkpIHtcclxuICAgIGxldCBkYXRhOiBSZW1vdmVEaXNoRnJvbUZhdm9yaXRlc1JlcXVlc3REYXRhID0ge1xyXG4gICAgICBkaXNoSWQ6IGRpc2guaWRcclxuICAgIH07XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvcmVtb3ZlL2Zhdm9yaXRlcyAnLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKHJlc3VsdDogYW55W10pID0+IHtcclxuICAgICAgICAgIGNvbnNvbGUuaW5mbygn0JHRi9C70L49Pj4+JywgdGhpcy5mYXZvcml0ZXMuZ2V0VmFsdWUoKS5sZW5ndGgpO1xyXG4gICAgICAgICAgbGV0IGZhdm9yaXRlc1VwZGF0ZWQ6IGFueVtdID0gdGhpcy5mYXZvcml0ZXNcclxuICAgICAgICAgICAgLmdldFZhbHVlKClcclxuICAgICAgICAgICAgLmZpbHRlcihpdGVtID0+IGl0ZW0uaWQgIT0gZGlzaC5pZCk7XHJcbiAgICAgICAgICBjb25zb2xlLmluZm8oJ9Ch0YLQsNC70L49Pj4+JywgZmF2b3JpdGVzVXBkYXRlZC5sZW5ndGgpO1xyXG4gICAgICAgICAgdGhpcy5mYXZvcml0ZXMubmV4dChyZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICB1c2VyUHJvZmlsZSgpOiBPYnNlcnZhYmxlPFVzZXI+IHtcclxuICAgIHJldHVybiAhIXRoaXMudXNlci52YWx1ZSA/IHRoaXMudXNlciA6IHRoaXMuZ2V0UHJvZmlsZSgpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldFByb2ZpbGUoKSksXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEZhdm9yaXRlcygpKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0QWRkcmVzc2VzKCkpLFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRCb251c2VzKCkpLFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy51c2VyKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHVzZXJJc0xvZ2dlZEluKCk6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiB7XHJcbiAgICByZXR1cm4gdGhpcy5pc0xvZ2dlZEluO1xyXG4gIH1cclxuXHJcbiAgdXNlckZhdm9yaXRlcygpOiBPYnNlcnZhYmxlPGFueVtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5mYXZvcml0ZXMucGlwZSgpO1xyXG4gIH1cclxuXHJcbiAgdXNlckFkZHJlc3NlcygpOiBPYnNlcnZhYmxlPEFkZHJlc3NbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuYWRkcmVzc2VzLnBpcGUoKTtcclxuICB9XHJcblxyXG4gIHVzZXJIaXN0b3J5KCk6IE9ic2VydmFibGU8YW55W10+IHtcclxuICAgIHJldHVybiB0aGlzLmhpc3RvcnlJdGVtcy5waXBlKCk7XHJcbiAgfVxyXG4gIHVzZXJUcmFuc2FjdGlvbnNIaXN0b3J5KCk6IE9ic2VydmFibGU8YW55W10+IHtcclxuICAgIHJldHVybiB0aGlzLmhpc3RvcnlUcmFuc2FjdGlvbnMucGlwZSgpO1xyXG4gIH1cclxuXHJcbiAgZ2V0QXV0aFRva2VuKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5hdXRoVG9rZW47XHJcbiAgfVxyXG5cclxuICBzZXRBdXRoVG9rZW4oYXV0aFRva2VuOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLnJlbWVtYmVyTWUpIHtcclxuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oTFNfVE9LRU5fTkFNRSwgYXV0aFRva2VuKTtcclxuICAgIH07XHJcbiAgICB0aGlzLmF1dGhUb2tlbiA9IGF1dGhUb2tlbjtcclxuICAgIHRoaXMuaXNMb2dnZWRJbi5uZXh0KHRydWUpO1xyXG4gICAgLyppZih1cGRhdGVQcm9maWxlKSB7XHJcbiAgICAgIHRoaXMuZ2V0UHJvZmlsZSgpLnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLmdldEZhdm9yaXRlcygpLnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLmdldEFkZHJlc3NlcygpLnN1YnNjcmliZSgpO1xyXG4gICAgICB0aGlzLmdldEhpc3RvcnkoKS5zdWJzY3JpYmUoKTtcclxuICAgIH0qL1xyXG4gIH1cclxuXHJcbiAgZGVsZXRlQXV0aFRva2VuKCk6IHZvaWQge1xyXG4gICAgdGhpcy5hdXRoVG9rZW4gPSBudWxsO1xyXG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oTFNfVE9LRU5fTkFNRSk7XHJcbiAgICB0aGlzLmlzTG9nZ2VkSW4ubmV4dChmYWxzZSk7XHJcbiAgfVxyXG5cclxuICBzYXZlQXZhdGFyKGF2YXRhcjogRmlsZSkge1xyXG4gICAgY29uc3QgZGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xyXG4gICAgZGF0YS5hcHBlbmQoJ2F2YXRhcicsIGF2YXRhciwgYXZhdGFyLm5hbWUpO1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL2F2YXRhci91cGxvYWQnLCBkYXRhLCB0cnVlLCB7XHJcbiAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdtdWx0aXBhcnQvZm9ybS1kYXRhJyB9LFxyXG4gICAgfSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIHJlc3VsdCA9PiB0aGlzLnVzZXIubmV4dChyZXN1bHQudXNlciksXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==