import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { filter, switchMap, tap } from 'rxjs/operators';
import { NetService } from '@webresto/ng-core';
import * as i0 from "@angular/core";
import * as i1 from "@webresto/ng-core";
const LS_TOKEN_NAME = 'gf:tkn:v2';
export class NgRestoUserService {
    constructor(net) {
        this.net = net;
        this.authToken = localStorage.getItem(LS_TOKEN_NAME);
        this.rememberMe = false;
        this.user = new BehaviorSubject({});
        this.isLoggedIn = new BehaviorSubject(this.authToken ? true : false);
        this.favorites = new BehaviorSubject([]);
        this.addresses = new BehaviorSubject([]);
        this.historyItems = new BehaviorSubject([]);
        this.historyTransactions = new BehaviorSubject([]);
        this.bonusSystems = new BehaviorSubject([]);
        this.isLoggedSubscription = this.isLoggedIn.pipe(filter(isLoggedIn => isLoggedIn === true), switchMap(() => this.getFavorites()), switchMap(() => this.getProfile()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses()), switchMap(() => this.getHistory())).subscribe(() => { }, () => { }, () => this.isLoggedSubscription.unsubscribe());
    }
    signIn(data, rememberMe = false) {
        this.rememberMe = rememberMe;
        return this.net.post('/signin', data).pipe(tap((result) => {
            this.setAuthToken(result.token);
            this.user.next(result.user);
            this.isLoggedIn.next(true);
        }, () => { }));
    }
    getProfile() {
        return this.net.get('/user/get/user-info').pipe(tap((result) => {
            this.user.next(result);
        }, () => { }));
    }
    getHistory() {
        return this.net.get('/user/get/history').pipe(tap((historyItems) => {
            this.historyItems.next(historyItems);
        }, error => {
            if ((error === null || error === void 0 ? void 0 : error.type) === "Unauthorized") {
                this.deleteAuthToken();
            }
            ;
        }));
    }
    getHistoryTransactions(bonusSystem = "local", limit = 15, set = 0) {
        return this.net.get(`/bonus/transactions?bonussystem=${bonusSystem}&limit=${limit}&number=${set}`).pipe(tap((transactions) => {
            this.historyTransactions.next(transactions);
        }, () => { }));
    }
    updateProfile(data) {
        return this.net.post('/user/set/user-info', {
            user: data
        }).pipe(tap((result) => {
            this.user.next(result.user);
        }, () => { }));
    }
    getAddresses() {
        return this.net.get('/user/get/location').pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    addAddress(address) {
        return this.net.post('/user/add/location', address).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    deleteAddress(address) {
        var reqBody = {
            id: address.id,
            street: address.street,
            home: address.home
        };
        return this.net.post('/user/remove/location', reqBody).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    signUp(data) {
        return this.net.post('/signup', data).pipe(tap((result) => {
            //this.setAuthToken(result.token, false);
            //this.user.next(result.user);
        }, () => { }));
    }
    signOut() {
        return this.deleteAuthToken();
    }
    getBonuses() {
        return this.net.post('/bonus/get', {}).pipe(tap(result => this.bonusSystems.next(result), () => { }));
    }
    resetPassword(data) {
        return this.net.post('/reset', data).pipe(tap(() => { }, () => { }));
    }
    resetPasswordCode(data) {
        return this.net.post('/code', data).pipe(tap(() => { }, () => { }));
    }
    getFavorites() {
        return this.net.get('/user/get/favorites').pipe(tap(result => {
            console.info('getFavorites result', result);
            this.favorites.next(result);
        }, () => { }));
    }
    addDishToFavorites(dish) {
        let data = {
            dishId: dish.id
        };
        return this.net.post('/user/add/favorites ', data).pipe(tap(result => {
            let favoritesUpdated = this.favorites.getValue();
            favoritesUpdated.push(dish);
            this.favorites.next(result);
        }, () => { }));
    }
    removeDishFromFavorites(dish) {
        let data = {
            dishId: dish.id
        };
        return this.net.post('/user/remove/favorites ', data).pipe(tap((result) => {
            console.info('Было=>>>', this.favorites.getValue().length);
            let favoritesUpdated = this.favorites
                .getValue()
                .filter(item => item.id != dish.id);
            console.info('Стало=>>>', favoritesUpdated.length);
            this.favorites.next(result);
        }, () => { }));
    }
    userProfile() {
        return this.user;
    }
    userIsLoggedIn() {
        return this.isLoggedIn;
    }
    userFavorites() {
        return this.favorites.pipe();
    }
    userAddresses() {
        return this.addresses.pipe();
    }
    userHistory() {
        return this.historyItems.pipe();
    }
    userTransactionsHistory() {
        return this.historyTransactions.pipe();
    }
    getAuthToken() {
        return this.authToken;
    }
    setAuthToken(authToken) {
        if (this.rememberMe) {
            localStorage.setItem(LS_TOKEN_NAME, authToken);
        }
        ;
        this.authToken = authToken;
        this.isLoggedIn.next(true);
        /*if(updateProfile) {
          this.getProfile().subscribe();
          this.getFavorites().subscribe();
          this.getAddresses().subscribe();
          this.getHistory().subscribe();
        }*/
    }
    deleteAuthToken() {
        this.authToken = null;
        localStorage.removeItem(LS_TOKEN_NAME);
        this.isLoggedIn.next(false);
    }
    saveAvatar(avatar) {
        const data = new FormData();
        data.append('avatar', avatar, avatar.name);
        return this.net.post('/user/avatar/upload', data, true, {
            headers: { 'Content-Type': 'multipart/form-data' },
        }).pipe(tap(result => this.user.next(result.user), () => { }));
    }
}
NgRestoUserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NgRestoUserService_Factory() { return new NgRestoUserService(i0.ɵɵinject(i1.NetService)); }, token: NgRestoUserService, providedIn: "root" });
NgRestoUserService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
NgRestoUserService.ctorParameters = () => [
    { type: NetService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcmVzdG8tdXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uL3Byb2plY3RzL3dlYnJlc3RvL25nLXVzZXIvc3JjLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL25nLXJlc3RvLXVzZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7QUFRL0MsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDO0FBS2xDLE1BQU0sT0FBTyxrQkFBa0I7SUFvQjdCLFlBQW9CLEdBQWU7UUFBZixRQUFHLEdBQUgsR0FBRyxDQUFZO1FBbEIzQixjQUFTLEdBQVcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4RCxlQUFVLEdBQVksS0FBSyxDQUFDO1FBQzVCLFNBQUksR0FBeUIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDckQsZUFBVSxHQUE2QixJQUFJLGVBQWUsQ0FBVSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25HLGNBQVMsR0FBMkIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDNUQsY0FBUyxHQUErQixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNoRSxpQkFBWSxHQUEyQixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMvRCx3QkFBbUIsR0FBMkIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEUsaUJBQVksR0FBMkIsSUFBSSxlQUFl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YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZmlsdGVyLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTmV0U2VydmljZSB9IGZyb20gJ0B3ZWJyZXN0by9uZy1jb3JlJztcclxuaW1wb3J0IHtcclxuICBBZGRyZXNzLCBTaWduSW5SZXF1ZXN0RGF0YSwgU2lnbkluUmVzcG9uc2VEYXRhLCBVc2VyLCBVcGRhdGVQcm9maWxlUmVxdWVzdERhdGEsXHJcbiAgVXBkYXRlUHJvZmlsZVJlc3BvbnNlRGF0YSwgQWRkQWRkcmVzc1JlcXVlc3REYXRhLCBSZW1vdmVBZGRyZXNzUmVxdWVzdERhdGEsIFNpZ25VcFJlcXVlc3REYXRhLFxyXG4gIFJlc2V0UGFzc3dvcmRSZXF1ZXN0RGF0YSwgUmVzZXRQYXNzd29yZENvZGVSZXF1ZXN0RGF0YSxcclxuICBBZGREaXNoVG9GYXZvcml0ZXNSZXF1ZXN0RGF0YSwgUmVtb3ZlRGlzaEZyb21GYXZvcml0ZXNSZXF1ZXN0RGF0YVxyXG59IGZyb20gJy4uLy4uL21vZGVscyc7XHJcblxyXG5jb25zdCBMU19UT0tFTl9OQU1FID0gJ2dmOnRrbjp2Mic7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZ1Jlc3RvVXNlclNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIGF1dGhUb2tlbjogc3RyaW5nID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oTFNfVE9LRU5fTkFNRSk7XHJcbiAgcHJpdmF0ZSByZW1lbWJlck1lOiBib29sZWFuID0gZmFsc2U7XHJcbiAgcHJpdmF0ZSB1c2VyOiBCZWhhdmlvclN1YmplY3Q8YW55PiA9IG5ldyBCZWhhdmlvclN1YmplY3Qoe30pO1xyXG4gIHByaXZhdGUgaXNMb2dnZWRJbjogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPih0aGlzLmF1dGhUb2tlbiA/IHRydWUgOiBmYWxzZSk7XHJcbiAgcHJpdmF0ZSBmYXZvcml0ZXM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuICBwcml2YXRlIGFkZHJlc3NlczogQmVoYXZpb3JTdWJqZWN0PEFkZHJlc3NbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuICBwcml2YXRlIGhpc3RvcnlJdGVtczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xyXG4gIHByaXZhdGUgaGlzdG9yeVRyYW5zYWN0aW9uczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xyXG4gIHByaXZhdGUgYm9udXNTeXN0ZW1zOiBCZWhhdmlvclN1YmplY3Q8YW55W10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4oW10pO1xyXG4gIHByaXZhdGUgaXNMb2dnZWRTdWJzY3JpcHRpb24gPSB0aGlzLmlzTG9nZ2VkSW4ucGlwZShcclxuICAgIGZpbHRlcihpc0xvZ2dlZEluID0+IGlzTG9nZ2VkSW4gPT09IHRydWUpLFxyXG4gICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0RmF2b3JpdGVzKCkpLFxyXG4gICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0UHJvZmlsZSgpKSxcclxuICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEFkZHJlc3NlcygpKSxcclxuICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEJvbnVzZXMoKSksXHJcbiAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRIaXN0b3J5KCkpXHJcbiAgKS5zdWJzY3JpYmUoKCkgPT4geyB9LCAoKSA9PiB7IH0sICgpID0+IHRoaXMuaXNMb2dnZWRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKSk7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbmV0OiBOZXRTZXJ2aWNlKSB7IH1cclxuXHJcbiAgc2lnbkluKGRhdGE6IFNpZ25JblJlcXVlc3REYXRhLCByZW1lbWJlck1lOiBib29sZWFuID0gZmFsc2UpIHtcclxuXHJcbiAgICB0aGlzLnJlbWVtYmVyTWUgPSByZW1lbWJlck1lO1xyXG5cclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvc2lnbmluJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChyZXN1bHQ6IFNpZ25JblJlc3BvbnNlRGF0YSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zZXRBdXRoVG9rZW4ocmVzdWx0LnRva2VuKTtcclxuICAgICAgICAgIHRoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcclxuICAgICAgICAgIHRoaXMuaXNMb2dnZWRJbi5uZXh0KHRydWUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcblxyXG4gIH1cclxuXHJcbiAgZ2V0UHJvZmlsZSgpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoJy91c2VyL2dldC91c2VyLWluZm8nKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKHJlc3VsdDogVXNlcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy51c2VyLm5leHQocmVzdWx0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0SGlzdG9yeSgpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoJy91c2VyL2dldC9oaXN0b3J5JykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChoaXN0b3J5SXRlbXMpID0+IHtcclxuICAgICAgICAgIHRoaXMuaGlzdG9yeUl0ZW1zLm5leHQoaGlzdG9yeUl0ZW1zKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVycm9yID0+IHtcclxuICAgICAgICAgIGlmIChlcnJvcj8udHlwZSA9PT0gXCJVbmF1dGhvcml6ZWRcIikge1xyXG4gICAgICAgICAgICB0aGlzLmRlbGV0ZUF1dGhUb2tlbigpO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGdldEhpc3RvcnlUcmFuc2FjdGlvbnMoYm9udXNTeXN0ZW06IHN0cmluZyA9IFwibG9jYWxcIiwgbGltaXQ6IG51bWJlciA9IDE1LCBzZXQ6IG51bWJlciA9IDApIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoYC9ib251cy90cmFuc2FjdGlvbnM/Ym9udXNzeXN0ZW09JHtib251c1N5c3RlbX0mbGltaXQ9JHtsaW1pdH0mbnVtYmVyPSR7c2V0fWApLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAodHJhbnNhY3Rpb25zKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmhpc3RvcnlUcmFuc2FjdGlvbnMubmV4dCh0cmFuc2FjdGlvbnMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGVQcm9maWxlKGRhdGE6IFVwZGF0ZVByb2ZpbGVSZXF1ZXN0RGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL3NldC91c2VyLWluZm8nLCB7XHJcbiAgICAgIHVzZXI6IGRhdGFcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAocmVzdWx0OiBVcGRhdGVQcm9maWxlUmVzcG9uc2VEYXRhKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnVzZXIubmV4dChyZXN1bHQudXNlcik7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKVxyXG4gIH1cclxuXHJcbiAgZ2V0QWRkcmVzc2VzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldCgnL3VzZXIvZ2V0L2xvY2F0aW9uJykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChhZGRyZXNzZXM6IEFkZHJlc3NbXSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5hZGRyZXNzZXMubmV4dChhZGRyZXNzZXMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBhZGRBZGRyZXNzKGFkZHJlc3M6IEFkZEFkZHJlc3NSZXF1ZXN0RGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL2FkZC9sb2NhdGlvbicsIGFkZHJlc3MpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAoYWRkcmVzc2VzOiBBZGRyZXNzW10pID0+IHtcclxuICAgICAgICAgIHRoaXMuYWRkcmVzc2VzLm5leHQoYWRkcmVzc2VzKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZGVsZXRlQWRkcmVzcyhhZGRyZXNzOiBBZGRyZXNzKSB7XHJcbiAgICB2YXIgcmVxQm9keTogUmVtb3ZlQWRkcmVzc1JlcXVlc3REYXRhID0ge1xyXG4gICAgICBpZDogYWRkcmVzcy5pZCxcclxuICAgICAgc3RyZWV0OiBhZGRyZXNzLnN0cmVldCxcclxuICAgICAgaG9tZTogYWRkcmVzcy5ob21lXHJcbiAgICB9O1xyXG5cclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvdXNlci9yZW1vdmUvbG9jYXRpb24nLCByZXFCb2R5KS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKGFkZHJlc3NlczogQWRkcmVzc1tdKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmFkZHJlc3Nlcy5uZXh0KGFkZHJlc3Nlcyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHNpZ25VcChkYXRhOiBTaWduVXBSZXF1ZXN0RGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9zaWdudXAnLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgLy90aGlzLnNldEF1dGhUb2tlbihyZXN1bHQudG9rZW4sIGZhbHNlKTtcclxuICAgICAgICAgIC8vdGhpcy51c2VyLm5leHQocmVzdWx0LnVzZXIpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzaWduT3V0KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZGVsZXRlQXV0aFRva2VuKCk7XHJcbiAgfVxyXG5cclxuXHJcbiAgZ2V0Qm9udXNlcygpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvYm9udXMvZ2V0Jywge30pLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICByZXN1bHQgPT4gdGhpcy5ib251c1N5c3RlbXMubmV4dChyZXN1bHQpLFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcmVzZXRQYXNzd29yZChkYXRhOiBSZXNldFBhc3N3b3JkUmVxdWVzdERhdGEpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvcmVzZXQnLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4geyB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcmVzZXRQYXNzd29yZENvZGUoZGF0YTogUmVzZXRQYXNzd29yZENvZGVSZXF1ZXN0RGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9jb2RlJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHsgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG5cclxuICBnZXRGYXZvcml0ZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQuZ2V0PGFueVtdPignL3VzZXIvZ2V0L2Zhdm9yaXRlcycpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5pbmZvKCdnZXRGYXZvcml0ZXMgcmVzdWx0JywgcmVzdWx0KTtcclxuICAgICAgICAgIHRoaXMuZmF2b3JpdGVzLm5leHQocmVzdWx0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgYWRkRGlzaFRvRmF2b3JpdGVzKGRpc2g6IGFueSkge1xyXG4gICAgbGV0IGRhdGE6IEFkZERpc2hUb0Zhdm9yaXRlc1JlcXVlc3REYXRhID0ge1xyXG4gICAgICBkaXNoSWQ6IGRpc2guaWRcclxuICAgIH07XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdDxBZGREaXNoVG9GYXZvcml0ZXNSZXF1ZXN0RGF0YSwgYW55W10+KCcvdXNlci9hZGQvZmF2b3JpdGVzICcsIGRhdGEpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgbGV0IGZhdm9yaXRlc1VwZGF0ZWQ6IGFueVtdID0gdGhpcy5mYXZvcml0ZXMuZ2V0VmFsdWUoKTtcclxuICAgICAgICAgIGZhdm9yaXRlc1VwZGF0ZWQucHVzaChkaXNoKTtcclxuICAgICAgICAgIHRoaXMuZmF2b3JpdGVzLm5leHQocmVzdWx0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlRGlzaEZyb21GYXZvcml0ZXMoZGlzaDogYW55KSB7XHJcbiAgICBsZXQgZGF0YTogUmVtb3ZlRGlzaEZyb21GYXZvcml0ZXNSZXF1ZXN0RGF0YSA9IHtcclxuICAgICAgZGlzaElkOiBkaXNoLmlkXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy91c2VyL3JlbW92ZS9mYXZvcml0ZXMgJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChyZXN1bHQ6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmluZm8oJ9CR0YvQu9C+PT4+PicsIHRoaXMuZmF2b3JpdGVzLmdldFZhbHVlKCkubGVuZ3RoKTtcclxuICAgICAgICAgIGxldCBmYXZvcml0ZXNVcGRhdGVkOiBhbnlbXSA9IHRoaXMuZmF2b3JpdGVzXHJcbiAgICAgICAgICAgIC5nZXRWYWx1ZSgpXHJcbiAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLmlkICE9IGRpc2guaWQpO1xyXG4gICAgICAgICAgY29uc29sZS5pbmZvKCfQodGC0LDQu9C+PT4+PicsIGZhdm9yaXRlc1VwZGF0ZWQubGVuZ3RoKTtcclxuICAgICAgICAgIHRoaXMuZmF2b3JpdGVzLm5leHQocmVzdWx0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgdXNlclByb2ZpbGUoKTogQmVoYXZpb3JTdWJqZWN0PFVzZXI+IHtcclxuICAgIHJldHVybiB0aGlzLnVzZXI7XHJcbiAgfVxyXG5cclxuICB1c2VySXNMb2dnZWRJbigpOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaXNMb2dnZWRJbjtcclxuICB9XHJcblxyXG4gIHVzZXJGYXZvcml0ZXMoKTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZmF2b3JpdGVzLnBpcGUoKTtcclxuICB9XHJcblxyXG4gIHVzZXJBZGRyZXNzZXMoKTogT2JzZXJ2YWJsZTxBZGRyZXNzW10+IHtcclxuICAgIHJldHVybiB0aGlzLmFkZHJlc3Nlcy5waXBlKCk7XHJcbiAgfVxyXG5cclxuICB1c2VySGlzdG9yeSgpOiBPYnNlcnZhYmxlPGFueVtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5oaXN0b3J5SXRlbXMucGlwZSgpO1xyXG4gIH1cclxuICB1c2VyVHJhbnNhY3Rpb25zSGlzdG9yeSgpOiBPYnNlcnZhYmxlPGFueVtdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5oaXN0b3J5VHJhbnNhY3Rpb25zLnBpcGUoKTtcclxuICB9XHJcblxyXG4gIGdldEF1dGhUb2tlbigpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuYXV0aFRva2VuO1xyXG4gIH1cclxuXHJcbiAgc2V0QXV0aFRva2VuKGF1dGhUb2tlbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5yZW1lbWJlck1lKSB7XHJcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKExTX1RPS0VOX05BTUUsIGF1dGhUb2tlbik7XHJcbiAgICB9O1xyXG4gICAgdGhpcy5hdXRoVG9rZW4gPSBhdXRoVG9rZW47XHJcbiAgICB0aGlzLmlzTG9nZ2VkSW4ubmV4dCh0cnVlKTtcclxuICAgIC8qaWYodXBkYXRlUHJvZmlsZSkge1xyXG4gICAgICB0aGlzLmdldFByb2ZpbGUoKS5zdWJzY3JpYmUoKTtcclxuICAgICAgdGhpcy5nZXRGYXZvcml0ZXMoKS5zdWJzY3JpYmUoKTtcclxuICAgICAgdGhpcy5nZXRBZGRyZXNzZXMoKS5zdWJzY3JpYmUoKTtcclxuICAgICAgdGhpcy5nZXRIaXN0b3J5KCkuc3Vic2NyaWJlKCk7XHJcbiAgICB9Ki9cclxuICB9XHJcblxyXG4gIGRlbGV0ZUF1dGhUb2tlbigpOiB2b2lkIHtcclxuICAgIHRoaXMuYXV0aFRva2VuID0gbnVsbDtcclxuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKExTX1RPS0VOX05BTUUpO1xyXG4gICAgdGhpcy5pc0xvZ2dlZEluLm5leHQoZmFsc2UpO1xyXG4gIH1cclxuXHJcbiAgc2F2ZUF2YXRhcihhdmF0YXI6IEZpbGUpIHtcclxuICAgIGNvbnN0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTtcclxuICAgIGRhdGEuYXBwZW5kKCdhdmF0YXInLCBhdmF0YXIsIGF2YXRhci5uYW1lKTtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvdXNlci9hdmF0YXIvdXBsb2FkJywgZGF0YSwgdHJ1ZSwge1xyXG4gICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnbXVsdGlwYXJ0L2Zvcm0tZGF0YScgfSxcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICByZXN1bHQgPT4gdGhpcy51c2VyLm5leHQocmVzdWx0LnVzZXIpLFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxufVxyXG4iXX0=