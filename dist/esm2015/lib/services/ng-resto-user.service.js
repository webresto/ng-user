import { Injectable } from '@angular/core';
import { NetService } from '@webresto/ng-core';
import { BehaviorSubject } from 'rxjs';
import { filter, switchMap, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@webresto/ng-core";
const LS_TOKEN_NAME = 'gf:tkn:v2';
export class NgRestoUserService {
    constructor(net) {
        this.net = net;
        this.authToken = localStorage.getItem(LS_TOKEN_NAME);
        this.rememberMe = false;
        this.isLoggedIn = new BehaviorSubject(this.authToken ? true : false);
        this.historyItems = new BehaviorSubject([]);
        this.historyTransactions = new BehaviorSubject([]);
        const isLoggedSubscription = this.isLoggedIn.pipe(filter(isLoggedIn => !!isLoggedIn), switchMap(() => this.getFavorites()), switchMap(() => this.getProfile()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses())).subscribe(() => { }, () => { }, () => isLoggedSubscription.unsubscribe());
    }
    signIn(data, rememberMe = false) {
        this.rememberMe = rememberMe;
        return this.net.post('/signin', data).pipe(tap((result) => {
            this.setAuthToken(result.token);
            this.user.next(result.user);
            this.isLoggedIn.next(true);
        }, () => { }));
    }
    getProfile() {
        return this.user ? this.user : this.net.get('/user/get/user-info').pipe(switchMap(result => {
            this.user.next(result);
            return this.user;
        }));
    }
    getHistory() {
        return this.net.get('/user/get/history').pipe(tap((historyItems) => {
            this.historyItems.next(historyItems);
        }, error => {
            if ((error === null || error === void 0 ? void 0 : error.type) === "Unauthorized") {
                this.deleteAuthToken();
            }
            ;
        }));
    }
    getHistoryTransactions(bonusSystem = "local", limit = 15, set = 0) {
        return this.net.get(`/bonus/transactions?bonussystem=${bonusSystem}&limit=${limit}&number=${set}`).pipe(tap((transactions) => {
            this.historyTransactions.next(transactions);
        }, () => { }));
    }
    updateProfile(data) {
        return this.net.post('/user/set/user-info', {
            user: data
        }).pipe(tap((result) => {
            this.user.next(result.user);
        }, () => { }));
    }
    getAddresses() {
        return this.addresses ? this.addresses : this.net.get('/user/get/location').pipe(switchMap(addresses => {
            this.addresses.next(addresses);
            return this.addresses;
        }));
    }
    addAddress(address) {
        return this.net.post('/user/add/location', address).pipe(switchMap(addresses => {
            this.addresses.next(addresses);
            return this.addresses;
        }));
    }
    deleteAddress(address) {
        return this.net.post('/user/remove/location', {
            id: address.id,
            street: address.street,
            home: address.home
        }).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    signUp(data) {
        return this.net.post('/signup', data).pipe(tap(() => {
            //this.setAuthToken(result.token, false);
            //this.user.next(result.user);
        }, () => { }));
    }
    signOut() {
        return this.deleteAuthToken();
    }
    getBonuses() {
        return this.bonusSystems ? this.bonusSystems : this.net.post('/bonus/get', {}).pipe(switchMap(result => {
            this.bonusSystems.next(result);
            return this.bonusSystems;
        }));
    }
    resetPassword(data) {
        return this.net.post('/reset', data).pipe(tap(() => { }, () => { }));
    }
    resetPasswordCode(data) {
        return this.net.post('/code', data).pipe(tap(() => { }, () => { }));
    }
    getFavorites() {
        return this.favorites ? this.favorites : this.net.get('/user/get/favorites').pipe(switchMap(result => {
            console.info('getFavorites result', result);
            this.favorites.next(result);
            return this.favorites;
        }));
    }
    addDishToFavorites(dish) {
        return this.net.post('/user/add/favorites ', {
            dishId: dish.id
        }).pipe(tap(result => this.favorites.next(result), () => { }));
    }
    removeDishFromFavorites(dish) {
        return this.net.post('/user/remove/favorites ', {
            dishId: dish.id
        }).pipe(tap(result => {
            console.info('Было=>>>', this.favorites.getValue().length);
            let favoritesUpdated = this.favorites
                .getValue()
                .filter(item => item.id != dish.id);
            console.info('Стало=>>>', favoritesUpdated.length);
            this.favorites.next(result);
        }, () => { }));
    }
    userProfile() {
        return !!this.user.value ? this.user : this.getProfile().pipe(switchMap(() => this.getProfile()), switchMap(() => this.getFavorites()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses()), switchMap(() => this.user));
    }
    userIsLoggedIn() {
        return this.isLoggedIn;
    }
    userFavorites() {
        return this.favorites.pipe();
    }
    userAddresses() {
        return this.addresses.pipe();
    }
    userHistory() {
        return this.historyItems.pipe();
    }
    userTransactionsHistory() {
        return this.historyTransactions.pipe();
    }
    getAuthToken() {
        return this.authToken;
    }
    setAuthToken(authToken) {
        if (this.rememberMe) {
            localStorage.setItem(LS_TOKEN_NAME, authToken);
        }
        ;
        this.authToken = authToken;
        this.isLoggedIn.next(true);
        /*if(updateProfile) {
          this.getProfile().subscribe();
          this.getFavorites().subscribe();
          this.getAddresses().subscribe();
          this.getHistory().subscribe();
        }*/
    }
    deleteAuthToken() {
        this.authToken = null;
        localStorage.removeItem(LS_TOKEN_NAME);
        this.isLoggedIn.next(false);
    }
    saveAvatar(avatar) {
        const data = new FormData();
        data.append('avatar', avatar, avatar.name);
        return this.net.post('/user/avatar/upload', data, true, {
            headers: { 'Content-Type': 'multipart/form-data' },
        }).pipe(tap(result => this.user.next(result.user), () => { }));
    }
}
NgRestoUserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NgRestoUserService_Factory() { return new NgRestoUserService(i0.ɵɵinject(i1.NetService)); }, token: NgRestoUserService, providedIn: "root" });
NgRestoUserService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
NgRestoUserService.ctorParameters = () => [
    { type: NetService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcmVzdG8tdXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvd2VicmVzdG8vbmctdXNlci9zcmMvbGliL3NlcnZpY2VzL25nLXJlc3RvLXVzZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFReEQsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDO0FBS2xDLE1BQU0sT0FBTyxrQkFBa0I7SUFZN0IsWUFBb0IsR0FBZTtRQUFmLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFWM0IsY0FBUyxHQUFXLFlBQVksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDeEQsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUU1QixlQUFVLEdBQTZCLElBQUksZUFBZSxDQUFVLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFHbkcsaUJBQVksR0FBMkIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDL0Qsd0JBQW1CLEdBQTJCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBSTVFLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQy9DLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsRUFDbEMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxFQUNw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Q0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQ3JDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FDVixDQUNGLENBQUM7SUFDSixDQUFDOzs7O1lBcFJGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBZFEsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTmV0U2VydmljZSB9IGZyb20gJ0B3ZWJyZXN0by9uZy1jb3JlJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7XHJcbiAgQWRkcmVzcywgU2lnbkluUmVxdWVzdERhdGEsIFNpZ25JblJlc3BvbnNlRGF0YSwgVXNlciwgVXBkYXRlUHJvZmlsZVJlcXVlc3REYXRhLFxyXG4gIFVwZGF0ZVByb2ZpbGVSZXNwb25zZURhdGEsIEFkZEFkZHJlc3NSZXF1ZXN0RGF0YSwgUmVtb3ZlQWRkcmVzc1JlcXVlc3REYXRhLCBTaWduVXBSZXF1ZXN0RGF0YSxcclxuICBSZXNldFBhc3N3b3JkUmVxdWVzdERhdGEsIFJlc2V0UGFzc3dvcmRDb2RlUmVxdWVzdERhdGEsXHJcbiAgQWRkRGlzaFRvRmF2b3JpdGVzUmVxdWVzdERhdGEsIFJlbW92ZURpc2hGcm9tRmF2b3JpdGVzUmVxdWVzdERhdGFcclxufSBmcm9tICcuLi8uLi9tb2RlbHMnO1xyXG5cclxuY29uc3QgTFNfVE9LRU5fTkFNRSA9ICdnZjp0a246djInO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgTmdSZXN0b1VzZXJTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBhdXRoVG9rZW46IHN0cmluZyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKExTX1RPS0VOX05BTUUpO1xyXG4gIHByaXZhdGUgcmVtZW1iZXJNZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIHByaXZhdGUgdXNlcjogQmVoYXZpb3JTdWJqZWN0PGFueT47XHJcbiAgcHJpdmF0ZSBpc0xvZ2dlZEluOiBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHRoaXMuYXV0aFRva2VuID8gdHJ1ZSA6IGZhbHNlKTtcclxuICBwcml2YXRlIGZhdm9yaXRlczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPjtcclxuICBwcml2YXRlIGFkZHJlc3NlczogQmVoYXZpb3JTdWJqZWN0PEFkZHJlc3NbXT47XHJcbiAgcHJpdmF0ZSBoaXN0b3J5SXRlbXM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuICBwcml2YXRlIGhpc3RvcnlUcmFuc2FjdGlvbnM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuICBwcml2YXRlIGJvbnVzU3lzdGVtczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuZXQ6IE5ldFNlcnZpY2UpIHtcclxuICAgIGNvbnN0IGlzTG9nZ2VkU3Vic2NyaXB0aW9uID0gdGhpcy5pc0xvZ2dlZEluLnBpcGUoXHJcbiAgICAgIGZpbHRlcihpc0xvZ2dlZEluID0+ICEhaXNMb2dnZWRJbiksXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEZhdm9yaXRlcygpKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0UHJvZmlsZSgpKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0QWRkcmVzc2VzKCkpLFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRCb251c2VzKCkpLFxyXG4gICAgKS5zdWJzY3JpYmUoKCkgPT4geyB9LCAoKSA9PiB7IH0sICgpID0+IGlzTG9nZ2VkU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzaWduSW4oZGF0YTogU2lnbkluUmVxdWVzdERhdGEsIHJlbWVtYmVyTWU6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG5cclxuICAgIHRoaXMucmVtZW1iZXJNZSA9IHJlbWVtYmVyTWU7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9zaWduaW4nLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKHJlc3VsdDogU2lnbkluUmVzcG9uc2VEYXRhKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNldEF1dGhUb2tlbihyZXN1bHQudG9rZW4pO1xyXG4gICAgICAgICAgdGhpcy51c2VyLm5leHQocmVzdWx0LnVzZXIpO1xyXG4gICAgICAgICAgdGhpcy5pc0xvZ2dlZEluLm5leHQodHJ1ZSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuXHJcbiAgfVxyXG5cclxuICBnZXRQcm9maWxlKCkge1xyXG4gICAgcmV0dXJuIHRoaXMudXNlciA/IHRoaXMudXNlciA6IHRoaXMubmV0LmdldDxVc2VyPignL3VzZXIvZ2V0L3VzZXItaW5mbycpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcChcclxuICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgdGhpcy51c2VyLm5leHQocmVzdWx0KTtcclxuICAgICAgICAgIHJldHVybiB0aGlzLnVzZXI7XHJcbiAgICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBnZXRIaXN0b3J5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldCgnL3VzZXIvZ2V0L2hpc3RvcnknKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKGhpc3RvcnlJdGVtcykgPT4ge1xyXG4gICAgICAgICAgdGhpcy5oaXN0b3J5SXRlbXMubmV4dChoaXN0b3J5SXRlbXMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgaWYgKGVycm9yPy50eXBlID09PSBcIlVuYXV0aG9yaXplZFwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlQXV0aFRva2VuKCk7XHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0SGlzdG9yeVRyYW5zYWN0aW9ucyhib251c1N5c3RlbTogc3RyaW5nID0gXCJsb2NhbFwiLCBsaW1pdDogbnVtYmVyID0gMTUsIHNldDogbnVtYmVyID0gMCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldChgL2JvbnVzL3RyYW5zYWN0aW9ucz9ib251c3N5c3RlbT0ke2JvbnVzU3lzdGVtfSZsaW1pdD0ke2xpbWl0fSZudW1iZXI9JHtzZXR9YCkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICh0cmFuc2FjdGlvbnMpID0+IHtcclxuICAgICAgICAgIHRoaXMuaGlzdG9yeVRyYW5zYWN0aW9ucy5uZXh0KHRyYW5zYWN0aW9ucyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHVwZGF0ZVByb2ZpbGUoZGF0YTogVXBkYXRlUHJvZmlsZVJlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvc2V0L3VzZXItaW5mbycsIHtcclxuICAgICAgdXNlcjogZGF0YVxyXG4gICAgfSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChyZXN1bHQ6IFVwZGF0ZVByb2ZpbGVSZXNwb25zZURhdGEpID0+IHtcclxuICAgICAgICAgIHRoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApXHJcbiAgfVxyXG5cclxuICBnZXRBZGRyZXNzZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5hZGRyZXNzZXMgPyB0aGlzLmFkZHJlc3NlcyA6IHRoaXMubmV0LmdldDxBZGRyZXNzW10+KCcvdXNlci9nZXQvbG9jYXRpb24nKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoXHJcbiAgICAgICAgYWRkcmVzc2VzID0+IHtcclxuICAgICAgICAgIHRoaXMuYWRkcmVzc2VzLm5leHQoYWRkcmVzc2VzKTtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmFkZHJlc3NlcztcclxuICAgICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGFkZEFkZHJlc3MoYWRkcmVzczogQWRkQWRkcmVzc1JlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdDxBZGRBZGRyZXNzUmVxdWVzdERhdGEsIEFkZHJlc3NbXT4oJy91c2VyL2FkZC9sb2NhdGlvbicsIGFkZHJlc3MpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcChcclxuICAgICAgICBhZGRyZXNzZXMgPT4ge1xyXG4gICAgICAgICAgdGhpcy5hZGRyZXNzZXMubmV4dChhZGRyZXNzZXMpO1xyXG4gICAgICAgICAgcmV0dXJuIHRoaXMuYWRkcmVzc2VzO1xyXG4gICAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZGVsZXRlQWRkcmVzcyhhZGRyZXNzOiBBZGRyZXNzKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdDxSZW1vdmVBZGRyZXNzUmVxdWVzdERhdGEsIEFkZHJlc3NbXT4oJy91c2VyL3JlbW92ZS9sb2NhdGlvbicsIHtcclxuICAgICAgaWQ6IGFkZHJlc3MuaWQsXHJcbiAgICAgIHN0cmVldDogYWRkcmVzcy5zdHJlZXQsXHJcbiAgICAgIGhvbWU6IGFkZHJlc3MuaG9tZVxyXG4gICAgfSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIChhZGRyZXNzZXM6IEFkZHJlc3NbXSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5hZGRyZXNzZXMubmV4dChhZGRyZXNzZXMpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBzaWduVXAoZGF0YTogU2lnblVwUmVxdWVzdERhdGEpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvc2lnbnVwJywgZGF0YSkucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIC8vdGhpcy5zZXRBdXRoVG9rZW4ocmVzdWx0LnRva2VuLCBmYWxzZSk7XHJcbiAgICAgICAgICAvL3RoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc2lnbk91dCgpIHtcclxuICAgIHJldHVybiB0aGlzLmRlbGV0ZUF1dGhUb2tlbigpO1xyXG4gIH1cclxuXHJcblxyXG4gIGdldEJvbnVzZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5ib251c1N5c3RlbXMgPyB0aGlzLmJvbnVzU3lzdGVtcyA6IHRoaXMubmV0LnBvc3QoJy9ib251cy9nZXQnLCB7fSkucGlwZShcclxuICAgICAgc3dpdGNoTWFwKFxyXG4gICAgICAgIHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICB0aGlzLmJvbnVzU3lzdGVtcy5uZXh0KHJlc3VsdCk7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5ib251c1N5c3RlbXM7XHJcbiAgICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXNldFBhc3N3b3JkKGRhdGE6IFJlc2V0UGFzc3dvcmRSZXF1ZXN0RGF0YSkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9yZXNldCcsIGRhdGEpLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICAoKSA9PiB7IH0sXHJcbiAgICAgICAgKCkgPT4geyB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXNldFBhc3N3b3JkQ29kZShkYXRhOiBSZXNldFBhc3N3b3JkQ29kZVJlcXVlc3REYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL2NvZGUnLCBkYXRhKS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4geyB9LFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcblxyXG4gIGdldEZhdm9yaXRlcygpIHtcclxuICAgIHJldHVybiB0aGlzLmZhdm9yaXRlcyA/IHRoaXMuZmF2b3JpdGVzIDogdGhpcy5uZXQuZ2V0PGFueVtdPignL3VzZXIvZ2V0L2Zhdm9yaXRlcycpLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcChcclxuICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5pbmZvKCdnZXRGYXZvcml0ZXMgcmVzdWx0JywgcmVzdWx0KTtcclxuICAgICAgICAgIHRoaXMuZmF2b3JpdGVzLm5leHQocmVzdWx0KTtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmZhdm9yaXRlcztcclxuICAgICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGFkZERpc2hUb0Zhdm9yaXRlcyhkaXNoOiBhbnkpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0PEFkZERpc2hUb0Zhdm9yaXRlc1JlcXVlc3REYXRhLCBhbnlbXT4oJy91c2VyL2FkZC9mYXZvcml0ZXMgJywge1xyXG4gICAgICBkaXNoSWQ6IGRpc2guaWRcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICByZXN1bHQgPT4gdGhpcy5mYXZvcml0ZXMubmV4dChyZXN1bHQpLFxyXG4gICAgICAgICgpID0+IHsgfVxyXG4gICAgICApXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlRGlzaEZyb21GYXZvcml0ZXMoZGlzaDogYW55KSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdDxSZW1vdmVEaXNoRnJvbUZhdm9yaXRlc1JlcXVlc3REYXRhLCBhbnlbXT4oJy91c2VyL3JlbW92ZS9mYXZvcml0ZXMgJywge1xyXG4gICAgICBkaXNoSWQ6IGRpc2guaWRcclxuICAgIH0pLnBpcGUoXHJcbiAgICAgIHRhcChcclxuICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5pbmZvKCfQkdGL0LvQvj0+Pj4nLCB0aGlzLmZhdm9yaXRlcy5nZXRWYWx1ZSgpLmxlbmd0aCk7XHJcbiAgICAgICAgICBsZXQgZmF2b3JpdGVzVXBkYXRlZDogYW55W10gPSB0aGlzLmZhdm9yaXRlc1xyXG4gICAgICAgICAgICAuZ2V0VmFsdWUoKVxyXG4gICAgICAgICAgICAuZmlsdGVyKGl0ZW0gPT4gaXRlbS5pZCAhPSBkaXNoLmlkKTtcclxuICAgICAgICAgIGNvbnNvbGUuaW5mbygn0KHRgtCw0LvQvj0+Pj4nLCBmYXZvcml0ZXNVcGRhdGVkLmxlbmd0aCk7XHJcbiAgICAgICAgICB0aGlzLmZhdm9yaXRlcy5uZXh0KHJlc3VsdCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHVzZXJQcm9maWxlKCk6IE9ic2VydmFibGU8VXNlcj4ge1xyXG4gICAgcmV0dXJuICEhdGhpcy51c2VyLnZhbHVlID8gdGhpcy51c2VyIDogdGhpcy5nZXRQcm9maWxlKCkucGlwZShcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0UHJvZmlsZSgpKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0RmF2b3JpdGVzKCkpLFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRBZGRyZXNzZXMoKSksXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEJvbnVzZXMoKSksXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnVzZXIpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgdXNlcklzTG9nZ2VkSW4oKTogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+IHtcclxuICAgIHJldHVybiB0aGlzLmlzTG9nZ2VkSW47XHJcbiAgfVxyXG5cclxuICB1c2VyRmF2b3JpdGVzKCk6IE9ic2VydmFibGU8YW55W10+IHtcclxuICAgIHJldHVybiB0aGlzLmZhdm9yaXRlcy5waXBlKCk7XHJcbiAgfVxyXG5cclxuICB1c2VyQWRkcmVzc2VzKCk6IE9ic2VydmFibGU8QWRkcmVzc1tdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5hZGRyZXNzZXMucGlwZSgpO1xyXG4gIH1cclxuXHJcbiAgdXNlckhpc3RvcnkoKTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeUl0ZW1zLnBpcGUoKTtcclxuICB9XHJcbiAgdXNlclRyYW5zYWN0aW9uc0hpc3RvcnkoKTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuaGlzdG9yeVRyYW5zYWN0aW9ucy5waXBlKCk7XHJcbiAgfVxyXG5cclxuICBnZXRBdXRoVG9rZW4oKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmF1dGhUb2tlbjtcclxuICB9XHJcblxyXG4gIHNldEF1dGhUb2tlbihhdXRoVG9rZW46IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMucmVtZW1iZXJNZSkge1xyXG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShMU19UT0tFTl9OQU1FLCBhdXRoVG9rZW4pO1xyXG4gICAgfTtcclxuICAgIHRoaXMuYXV0aFRva2VuID0gYXV0aFRva2VuO1xyXG4gICAgdGhpcy5pc0xvZ2dlZEluLm5leHQodHJ1ZSk7XHJcbiAgICAvKmlmKHVwZGF0ZVByb2ZpbGUpIHtcclxuICAgICAgdGhpcy5nZXRQcm9maWxlKCkuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHRoaXMuZ2V0RmF2b3JpdGVzKCkuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHRoaXMuZ2V0QWRkcmVzc2VzKCkuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHRoaXMuZ2V0SGlzdG9yeSgpLnN1YnNjcmliZSgpO1xyXG4gICAgfSovXHJcbiAgfVxyXG5cclxuICBkZWxldGVBdXRoVG9rZW4oKTogdm9pZCB7XHJcbiAgICB0aGlzLmF1dGhUb2tlbiA9IG51bGw7XHJcbiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShMU19UT0tFTl9OQU1FKTtcclxuICAgIHRoaXMuaXNMb2dnZWRJbi5uZXh0KGZhbHNlKTtcclxuICB9XHJcblxyXG4gIHNhdmVBdmF0YXIoYXZhdGFyOiBGaWxlKSB7XHJcbiAgICBjb25zdCBkYXRhID0gbmV3IEZvcm1EYXRhKCk7XHJcbiAgICBkYXRhLmFwcGVuZCgnYXZhdGFyJywgYXZhdGFyLCBhdmF0YXIubmFtZSk7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvYXZhdGFyL3VwbG9hZCcsIGRhdGEsIHRydWUsIHtcclxuICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ211bHRpcGFydC9mb3JtLWRhdGEnIH0sXHJcbiAgICB9KS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgcmVzdWx0ID0+IHRoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKSxcclxuICAgICAgICAoKSA9PiB7IH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19