import { Injectable } from '@angular/core';
import { NetService } from '@webresto/ng-core';
import { BehaviorSubject, of } from 'rxjs';
import { map } from 'rxjs/operators';
import { filter, switchMap, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@webresto/ng-core";
const LS_TOKEN_NAME = 'gf:tkn:v2';
export class NgRestoUserService {
    constructor(net) {
        this.net = net;
        this.authToken = localStorage.getItem(LS_TOKEN_NAME);
        this.rememberMe = false;
        this.isLoggedIn = new BehaviorSubject(this.authToken ? true : false);
        this.historyItems = new BehaviorSubject([]);
        this.historyTransactions = new BehaviorSubject([]);
        const isLoggedSubscription = this.isLoggedIn.pipe(filter(isLoggedIn => !!isLoggedIn), switchMap(() => this.getFavorites()), switchMap(() => this.getProfile()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses())).subscribe(() => { }, () => { }, () => isLoggedSubscription.unsubscribe());
    }
    signIn(data, rememberMe = false) {
        this.rememberMe = rememberMe;
        return this.net.post('/signin', data).pipe(tap((result) => {
            this.setAuthToken(result.token);
            this.user.next(result.user);
            this.isLoggedIn.next(true);
        }, () => { }));
    }
    getProfile() {
        return this.user ? this.user : this.net.get('/user/get/user-info').pipe(switchMap(result => {
            this.user = new BehaviorSubject(result);
            return this.user;
        }));
    }
    getHistory() {
        return this.net.get('/user/get/history').pipe(tap((historyItems) => {
            this.historyItems.next(historyItems);
        }, error => {
            if ((error === null || error === void 0 ? void 0 : error.type) === "Unauthorized") {
                this.deleteAuthToken();
            }
            ;
        }));
    }
    getHistoryTransactions(bonusSystem = "local", limit = 15, set = 0) {
        return this.net.get(`/bonus/transactions?bonussystem=${bonusSystem}&limit=${limit}&number=${set}`).pipe(tap((transactions) => {
            this.historyTransactions.next(transactions);
        }, () => { }));
    }
    updateProfile(data) {
        return this.net.post('/user/set/user-info', {
            user: data
        }).pipe(tap((result) => {
            this.user.next(result.user);
        }, () => { }));
    }
    getAddresses() {
        return this.addresses ? this.addresses : this.net.get('/user/get/location').pipe(switchMap(addresses => {
            this.addresses = new BehaviorSubject(addresses);
            return this.addresses;
        }));
    }
    addAddress(address) {
        return this.net.post('/user/add/location', address).pipe(switchMap(addresses => {
            this.addresses.next(addresses);
            return this.addresses;
        }));
    }
    deleteAddress(address) {
        return this.net.post('/user/remove/location', {
            id: address.id,
            street: address.street,
            home: address.home
        }).pipe(tap((addresses) => {
            this.addresses.next(addresses);
        }, () => { }));
    }
    signUp(data) {
        return this.net.post('/signup', data).pipe(tap(() => {
            //this.setAuthToken(result.token, false);
            //this.user.next(result.user);
        }, () => { }));
    }
    signOut() {
        return this.deleteAuthToken();
    }
    getBonuses() {
        return this.bonusSystems ? this.bonusSystems : this.net.post('/bonus/get', {}).pipe(switchMap(result => {
            this.bonusSystems = new BehaviorSubject(result);
            return this.bonusSystems;
        }));
    }
    resetPassword(data) {
        return this.net.post('/reset', data).pipe(tap(() => { }, () => { }));
    }
    resetPasswordCode(data) {
        return this.net.post('/code', data).pipe(tap(() => { }, () => { }));
    }
    getFavorites() {
        return this.favorites ? this.favorites : this.net.get('/user/get/favorites').pipe(switchMap(result => {
            console.info('getFavorites result', result);
            this.favorites = new BehaviorSubject(result);
            return this.favorites;
        }));
    }
    addDishToFavorites(dish) {
        return this.net.post('/user/add/favorites ', {
            dishId: dish.id
        }).pipe(map(result => this.favorites.next(result)));
    }
    removeDishFromFavorites(dish) {
        return this.net.post('/user/remove/favorites ', {
            dishId: dish.id
        }).pipe(tap(result => {
            console.info('Было=>>>', this.favorites.getValue().length);
            let favoritesUpdated = this.favorites
                .getValue()
                .filter(item => item.id != dish.id);
            console.info('Стало=>>>', favoritesUpdated.length);
            this.favorites.next(result);
        }, () => { }));
    }
    userProfile() {
        return this.user ? this.user : this.getProfile().pipe(switchMap(() => this.getFavorites()), switchMap(() => this.getAddresses()), switchMap(() => this.getBonuses()), switchMap(() => this.user));
    }
    userIsLoggedIn() {
        return this.isLoggedIn;
    }
    userFavorites() {
        return this.favorites ? this.favorites.asObservable() : of([]);
    }
    userAddresses() {
        return this.addresses ? this.addresses.asObservable() : of([]);
    }
    userHistory() {
        return this.historyItems ? this.historyItems.asObservable() : of([]);
    }
    userTransactionsHistory() {
        return this.historyTransactions ? this.historyTransactions.asObservable() : of([]);
    }
    getAuthToken() {
        return this.authToken;
    }
    setAuthToken(authToken) {
        if (this.rememberMe) {
            localStorage.setItem(LS_TOKEN_NAME, authToken);
        }
        ;
        this.authToken = authToken;
        this.isLoggedIn.next(true);
        /*if(updateProfile) {
          this.getProfile().subscribe();
          this.getFavorites().subscribe();
          this.getAddresses().subscribe();
          this.getHistory().subscribe();
        }*/
    }
    deleteAuthToken() {
        this.authToken = null;
        localStorage.removeItem(LS_TOKEN_NAME);
        this.isLoggedIn.next(false);
    }
    saveAvatar(avatar) {
        const data = new FormData();
        data.append('avatar', avatar, avatar.name);
        return this.net.post('/user/avatar/upload', data, true, {
            headers: { 'Content-Type': 'multipart/form-data' },
        }).pipe(tap(result => this.user.next(result.user), () => { }));
    }
}
NgRestoUserService.ɵprov = i0.ɵɵdefineInjectable({ factory: function NgRestoUserService_Factory() { return new NgRestoUserService(i0.ɵɵinject(i1.NetService)); }, token: NgRestoUserService, providedIn: "root" });
NgRestoUserService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
NgRestoUserService.ctorParameters = () => [
    { type: NetService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcmVzdG8tdXNlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvd2VicmVzdG8vbmctdXNlci9zcmMvbGliL3NlcnZpY2VzL25nLXJlc3RvLXVzZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsZUFBZSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7OztBQVF4RCxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUM7QUFLbEMsTUFBTSxPQUFPLGtCQUFrQjtJQVk3QixZQUFvQixHQUFlO1FBQWYsUUFBRyxHQUFILEdBQUcsQ0FBWTtRQVYzQixjQUFTLEdBQVcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4RCxlQUFVLEdBQVksS0FBSyxDQUFDO1FBRTVCLGVBQVUsR0FBNkIsSUFBSSxlQUFlLENBQVUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUduRyxpQkFBWSxHQUEyQixJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMvRCx3QkFBbUIsR0FBMkIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFJNUUsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FDL0MsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxFQUNsQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLEVBQ3BDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsRUFDbEMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxFQUNwQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQ25DLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLENBQ3pFLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQXVCLEVBQUUsYUFBc0IsS0FBSztRQUV6RCxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUU3QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQ3hDLEdBQUcsQ0FDRCxDQUFDLE1BQTBCLEVBQUUsRUFBRTtZQUM3QixJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsQ0FBQyxFQUNELEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FDVixDQUNGLENBQUM7SUFFSixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQU8scUJBQXFCLENBQUMsQ0FBQyxJQUFJLENBQzNFLFNBQVMsQ0FDUCxNQUFNLENBQUMsRUFBRTtZQUNQLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ25CLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxJQUFJLENBQzNDLEdBQUcsQ0FDRCxDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ2YsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkMsQ0FBQyxFQUNELEtBQUssQ0FBQyxFQUFFO1lBQ04sSUFBSSxDQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxJQUFJLE1BQUssY0FBYyxFQUFFO2dCQUNsQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7YUFDeEI7WUFBQSxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0wsQ0FBQztJQUNKLENBQUM7SUFFRCxzQkFBc0IsQ0FBQyxjQUFzQixPQUFPLEVBQUUsUUFBZ0IsRUFBRSxFQUFFLE1BQWMsQ0FBQztRQUN2RixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxXQUFXLFVBQVUsS0FBSyxXQUFXLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUNyRyxHQUFHLENBQ0QsQ0FBQyxZQUFZLEVBQUUsRUFBRTtZQUNmLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDOUMsQ0FBQyxFQUNELEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FDVixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsYUFBYSxDQUFDLElBQThCO1FBQzFDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUU7WUFDMUMsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDLENBQUMsSUFBSSxDQUNMLEdBQUcsQ0FDRCxDQUFDLE1BQWlDLEVBQUUsRUFBRTtZQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsQ0FBQyxFQUNELEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FDVixDQUNGLENBQUE7SUFDSCxDQUFDO0lBRUQsWUFBWTtRQUNWLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQVksb0JBQW9CLENBQUMsQ0FBQyxJQUFJLENBQ3pGLFNBQVMsQ0FDUCxTQUFTLENBQUMsRUFBRTtZQUNWLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDaEQsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDSixDQUFDO0lBRUQsVUFBVSxDQUFDLE9BQThCO1FBQ3ZDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQW1DLG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDeEYsU0FBUyxDQUNQLFNBQVMsQ0FBQyxFQUFFO1lBQ1YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDL0IsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDSixDQUFDO0lBRUQsYUFBYSxDQUFDLE9BQWdCO1FBQzVCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQXNDLHVCQUF1QixFQUFFO1lBQ2pGLEVBQUUsRUFBRSxPQUFPLENBQUMsRUFBRTtZQUNkLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTtZQUN0QixJQUFJLEVBQUUsT0FBTyxDQUFDLElBQUk7U0FDbkIsQ0FBQyxDQUFDLElBQUksQ0FDTCxHQUFHLENBQ0QsQ0FBQyxTQUFvQixFQUFFLEVBQUU7WUFDdkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDakMsQ0FBQyxFQUNELEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FDVixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLElBQXVCO1FBQzVCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FDeEMsR0FBRyxDQUNELEdBQUcsRUFBRTtZQUNILHlDQUF5QztZQUN6Qyw4QkFBOEI7UUFDaEMsQ0FBQyxFQUNELEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FDVixDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFHRCxVQUFVO1FBQ1IsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUNqRixTQUFTLENBQ1AsTUFBTSxDQUFDLEVBQUU7WUFDUCxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2hELE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FDTCxDQUFDO0lBQ0osQ0FBQztJQUVELGFBQWEsQ0FBQyxJQUE4QjtRQUMxQyxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQ3ZDLEdBQUcsQ0FDRCxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQ1QsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUNWLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxJQUFrQztRQUNsRCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQ3RDLEdBQUcsQ0FDRCxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQ1QsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUNWLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFHRCxZQUFZO1FBQ1YsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBUSxxQkFBcUIsQ0FBQyxDQUFDLElBQUksQ0FDdEYsU0FBUyxDQUNQLE1BQU0sQ0FBQyxFQUFFO1lBQ1AsT0FBTyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUM1QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzdDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FDTCxDQUFDO0lBQ0osQ0FBQztJQUVELGtCQUFrQixDQUFDLElBQVM7UUFDMUIsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBdUMsc0JBQXNCLEVBQUU7WUFDakYsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFO1NBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQ0wsR0FBRyxDQUNELE1BQU0sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQ3RDLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFRCx1QkFBdUIsQ0FBQyxJQUFTO1FBQy9CLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQTRDLHlCQUF5QixFQUFFO1lBQ3pGLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRTtTQUNoQixDQUFDLENBQUMsSUFBSSxDQUNMLEdBQUcsQ0FDRCxNQUFNLENBQUMsRUFBRTtZQUNQLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDM0QsSUFBSSxnQkFBZ0IsR0FBVSxJQUFJLENBQUMsU0FBUztpQkFDekMsUUFBUSxFQUFFO2lCQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3RDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlCLENBQUMsRUFDRCxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQ1YsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELFdBQVc7UUFDVCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxJQUFJLENBQ25ELFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsRUFDcEMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxFQUNwQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDLEVBQ2xDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQzNCLENBQUM7SUFDSixDQUFDO0lBRUQsY0FBYztRQUNaLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUN6QixDQUFDO0lBRUQsYUFBYTtRQUNYLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRCxhQUFhO1FBQ1gsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVELFdBQVc7UUFDVCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2RSxDQUFDO0lBRUQsdUJBQXVCO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNyRixDQUFDO0lBRUQsWUFBWTtRQUNWLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUN4QixDQUFDO0lBRUQsWUFBWSxDQUFDLFNBQWlCO1FBQzVCLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixZQUFZLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUNoRDtRQUFBLENBQUM7UUFDRixJQUFJLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztRQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQjs7Ozs7V0FLRztJQUNMLENBQUM7SUFFRCxlQUFlO1FBQ2IsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDdEIsWUFBWSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQsVUFBVSxDQUFDLE1BQVk7UUFDckIsTUFBTSxJQUFJLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMscUJBQXFCLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRTtZQUN0RCxPQUFPLEVBQUUsRUFBRSxjQUFjLEVBQUUscUJBQXFCLEVBQUU7U0FDbkQsQ0FBQyxDQUFDLElBQUksQ0FDTCxHQUFHLENBQ0QsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQ3JDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FDVixDQUNGLENBQUM7SUFDSixDQUFDOzs7O1lBblJGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7O1lBZlEsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5ldFNlcnZpY2UgfSBmcm9tICdAd2VicmVzdG8vbmctY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgQWRkcmVzcywgU2lnbkluUmVxdWVzdERhdGEsIFNpZ25JblJlc3BvbnNlRGF0YSwgVXNlciwgVXBkYXRlUHJvZmlsZVJlcXVlc3REYXRhLFxuICBVcGRhdGVQcm9maWxlUmVzcG9uc2VEYXRhLCBBZGRBZGRyZXNzUmVxdWVzdERhdGEsIFJlbW92ZUFkZHJlc3NSZXF1ZXN0RGF0YSwgU2lnblVwUmVxdWVzdERhdGEsXG4gIFJlc2V0UGFzc3dvcmRSZXF1ZXN0RGF0YSwgUmVzZXRQYXNzd29yZENvZGVSZXF1ZXN0RGF0YSxcbiAgQWRkRGlzaFRvRmF2b3JpdGVzUmVxdWVzdERhdGEsIFJlbW92ZURpc2hGcm9tRmF2b3JpdGVzUmVxdWVzdERhdGFcbn0gZnJvbSAnLi4vLi4vbW9kZWxzJztcblxuY29uc3QgTFNfVE9LRU5fTkFNRSA9ICdnZjp0a246djInO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBOZ1Jlc3RvVXNlclNlcnZpY2Uge1xuXG4gIHByaXZhdGUgYXV0aFRva2VuOiBzdHJpbmcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShMU19UT0tFTl9OQU1FKTtcbiAgcHJpdmF0ZSByZW1lbWJlck1lOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgdXNlcjogQmVoYXZpb3JTdWJqZWN0PFVzZXI+O1xuICBwcml2YXRlIGlzTG9nZ2VkSW46IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odGhpcy5hdXRoVG9rZW4gPyB0cnVlIDogZmFsc2UpO1xuICBwcml2YXRlIGZhdm9yaXRlczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPjtcbiAgcHJpdmF0ZSBhZGRyZXNzZXM6IEJlaGF2aW9yU3ViamVjdDxBZGRyZXNzW10+O1xuICBwcml2YXRlIGhpc3RvcnlJdGVtczogQmVoYXZpb3JTdWJqZWN0PGFueVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuICBwcml2YXRlIGhpc3RvcnlUcmFuc2FjdGlvbnM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcbiAgcHJpdmF0ZSBib251c1N5c3RlbXM6IEJlaGF2aW9yU3ViamVjdDxhbnlbXT47XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBuZXQ6IE5ldFNlcnZpY2UpIHtcbiAgICBjb25zdCBpc0xvZ2dlZFN1YnNjcmlwdGlvbiA9IHRoaXMuaXNMb2dnZWRJbi5waXBlKFxuICAgICAgZmlsdGVyKGlzTG9nZ2VkSW4gPT4gISFpc0xvZ2dlZEluKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldEZhdm9yaXRlcygpKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldFByb2ZpbGUoKSksXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRBZGRyZXNzZXMoKSksXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXRCb251c2VzKCkpLFxuICAgICkuc3Vic2NyaWJlKCgpID0+IHsgfSwgKCkgPT4geyB9LCAoKSA9PiBpc0xvZ2dlZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpXG4gICAgKTtcbiAgfVxuXG4gIHNpZ25JbihkYXRhOiBTaWduSW5SZXF1ZXN0RGF0YSwgcmVtZW1iZXJNZTogYm9vbGVhbiA9IGZhbHNlKSB7XG5cbiAgICB0aGlzLnJlbWVtYmVyTWUgPSByZW1lbWJlck1lO1xuXG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9zaWduaW4nLCBkYXRhKS5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAocmVzdWx0OiBTaWduSW5SZXNwb25zZURhdGEpID0+IHtcbiAgICAgICAgICB0aGlzLnNldEF1dGhUb2tlbihyZXN1bHQudG9rZW4pO1xuICAgICAgICAgIHRoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcbiAgICAgICAgICB0aGlzLmlzTG9nZ2VkSW4ubmV4dCh0cnVlKTtcbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4geyB9XG4gICAgICApXG4gICAgKTtcblxuICB9XG5cbiAgZ2V0UHJvZmlsZSgpIHtcbiAgICByZXR1cm4gdGhpcy51c2VyID8gdGhpcy51c2VyIDogdGhpcy5uZXQuZ2V0PFVzZXI+KCcvdXNlci9nZXQvdXNlci1pbmZvJykucGlwZShcbiAgICAgIHN3aXRjaE1hcChcbiAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICB0aGlzLnVzZXIgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHJlc3VsdCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMudXNlcjtcbiAgICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0SGlzdG9yeSgpIHtcbiAgICByZXR1cm4gdGhpcy5uZXQuZ2V0KCcvdXNlci9nZXQvaGlzdG9yeScpLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgIChoaXN0b3J5SXRlbXMpID0+IHtcbiAgICAgICAgICB0aGlzLmhpc3RvcnlJdGVtcy5uZXh0KGhpc3RvcnlJdGVtcyk7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICBpZiAoZXJyb3I/LnR5cGUgPT09IFwiVW5hdXRob3JpemVkXCIpIHtcbiAgICAgICAgICAgIHRoaXMuZGVsZXRlQXV0aFRva2VuKCk7XG4gICAgICAgICAgfTtcbiAgICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0SGlzdG9yeVRyYW5zYWN0aW9ucyhib251c1N5c3RlbTogc3RyaW5nID0gXCJsb2NhbFwiLCBsaW1pdDogbnVtYmVyID0gMTUsIHNldDogbnVtYmVyID0gMCkge1xuICAgIHJldHVybiB0aGlzLm5ldC5nZXQoYC9ib251cy90cmFuc2FjdGlvbnM/Ym9udXNzeXN0ZW09JHtib251c1N5c3RlbX0mbGltaXQ9JHtsaW1pdH0mbnVtYmVyPSR7c2V0fWApLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgICh0cmFuc2FjdGlvbnMpID0+IHtcbiAgICAgICAgICB0aGlzLmhpc3RvcnlUcmFuc2FjdGlvbnMubmV4dCh0cmFuc2FjdGlvbnMpO1xuICAgICAgICB9LFxuICAgICAgICAoKSA9PiB7IH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgdXBkYXRlUHJvZmlsZShkYXRhOiBVcGRhdGVQcm9maWxlUmVxdWVzdERhdGEpIHtcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvc2V0L3VzZXItaW5mbycsIHtcbiAgICAgIHVzZXI6IGRhdGFcbiAgICB9KS5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAocmVzdWx0OiBVcGRhdGVQcm9maWxlUmVzcG9uc2VEYXRhKSA9PiB7XG4gICAgICAgICAgdGhpcy51c2VyLm5leHQocmVzdWx0LnVzZXIpO1xuICAgICAgICB9LFxuICAgICAgICAoKSA9PiB7IH1cbiAgICAgIClcbiAgICApXG4gIH1cblxuICBnZXRBZGRyZXNzZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuYWRkcmVzc2VzID8gdGhpcy5hZGRyZXNzZXMgOiB0aGlzLm5ldC5nZXQ8QWRkcmVzc1tdPignL3VzZXIvZ2V0L2xvY2F0aW9uJykucGlwZShcbiAgICAgIHN3aXRjaE1hcChcbiAgICAgICAgYWRkcmVzc2VzID0+IHtcbiAgICAgICAgICB0aGlzLmFkZHJlc3NlcyA9IG5ldyBCZWhhdmlvclN1YmplY3QoYWRkcmVzc2VzKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hZGRyZXNzZXM7XG4gICAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGFkZEFkZHJlc3MoYWRkcmVzczogQWRkQWRkcmVzc1JlcXVlc3REYXRhKSB7XG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3Q8QWRkQWRkcmVzc1JlcXVlc3REYXRhLCBBZGRyZXNzW10+KCcvdXNlci9hZGQvbG9jYXRpb24nLCBhZGRyZXNzKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKFxuICAgICAgICBhZGRyZXNzZXMgPT4ge1xuICAgICAgICAgIHRoaXMuYWRkcmVzc2VzLm5leHQoYWRkcmVzc2VzKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5hZGRyZXNzZXM7XG4gICAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZUFkZHJlc3MoYWRkcmVzczogQWRkcmVzcykge1xuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0PFJlbW92ZUFkZHJlc3NSZXF1ZXN0RGF0YSwgQWRkcmVzc1tdPignL3VzZXIvcmVtb3ZlL2xvY2F0aW9uJywge1xuICAgICAgaWQ6IGFkZHJlc3MuaWQsXG4gICAgICBzdHJlZXQ6IGFkZHJlc3Muc3RyZWV0LFxuICAgICAgaG9tZTogYWRkcmVzcy5ob21lXG4gICAgfSkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKGFkZHJlc3NlczogQWRkcmVzc1tdKSA9PiB7XG4gICAgICAgICAgdGhpcy5hZGRyZXNzZXMubmV4dChhZGRyZXNzZXMpO1xuICAgICAgICB9LFxuICAgICAgICAoKSA9PiB7IH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgc2lnblVwKGRhdGE6IFNpZ25VcFJlcXVlc3REYXRhKSB7XG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9zaWdudXAnLCBkYXRhKS5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgLy90aGlzLnNldEF1dGhUb2tlbihyZXN1bHQudG9rZW4sIGZhbHNlKTtcbiAgICAgICAgICAvL3RoaXMudXNlci5uZXh0KHJlc3VsdC51c2VyKTtcbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4geyB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHNpZ25PdXQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZGVsZXRlQXV0aFRva2VuKCk7XG4gIH1cblxuXG4gIGdldEJvbnVzZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuYm9udXNTeXN0ZW1zID8gdGhpcy5ib251c1N5c3RlbXMgOiB0aGlzLm5ldC5wb3N0KCcvYm9udXMvZ2V0Jywge30pLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoXG4gICAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgICAgdGhpcy5ib251c1N5c3RlbXMgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHJlc3VsdCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYm9udXNTeXN0ZW1zO1xuICAgICAgICB9KVxuICAgICk7XG4gIH1cblxuICByZXNldFBhc3N3b3JkKGRhdGE6IFJlc2V0UGFzc3dvcmRSZXF1ZXN0RGF0YSkge1xuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvcmVzZXQnLCBkYXRhKS5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7IH0sXG4gICAgICAgICgpID0+IHsgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICByZXNldFBhc3N3b3JkQ29kZShkYXRhOiBSZXNldFBhc3N3b3JkQ29kZVJlcXVlc3REYXRhKSB7XG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3QoJy9jb2RlJywgZGF0YSkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKCkgPT4geyB9LFxuICAgICAgICAoKSA9PiB7IH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cblxuICBnZXRGYXZvcml0ZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuZmF2b3JpdGVzID8gdGhpcy5mYXZvcml0ZXMgOiB0aGlzLm5ldC5nZXQ8YW55W10+KCcvdXNlci9nZXQvZmF2b3JpdGVzJykucGlwZShcbiAgICAgIHN3aXRjaE1hcChcbiAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICBjb25zb2xlLmluZm8oJ2dldEZhdm9yaXRlcyByZXN1bHQnLCByZXN1bHQpO1xuICAgICAgICAgIHRoaXMuZmF2b3JpdGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdChyZXN1bHQpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmZhdm9yaXRlcztcbiAgICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgYWRkRGlzaFRvRmF2b3JpdGVzKGRpc2g6IGFueSkge1xuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0PEFkZERpc2hUb0Zhdm9yaXRlc1JlcXVlc3REYXRhLCBhbnlbXT4oJy91c2VyL2FkZC9mYXZvcml0ZXMgJywge1xuICAgICAgZGlzaElkOiBkaXNoLmlkXG4gICAgfSkucGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgcmVzdWx0ID0+IHRoaXMuZmF2b3JpdGVzLm5leHQocmVzdWx0KSxcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcmVtb3ZlRGlzaEZyb21GYXZvcml0ZXMoZGlzaDogYW55KSB7XG4gICAgcmV0dXJuIHRoaXMubmV0LnBvc3Q8UmVtb3ZlRGlzaEZyb21GYXZvcml0ZXNSZXF1ZXN0RGF0YSwgYW55W10+KCcvdXNlci9yZW1vdmUvZmF2b3JpdGVzICcsIHtcbiAgICAgIGRpc2hJZDogZGlzaC5pZFxuICAgIH0pLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgICAgY29uc29sZS5pbmZvKCfQkdGL0LvQvj0+Pj4nLCB0aGlzLmZhdm9yaXRlcy5nZXRWYWx1ZSgpLmxlbmd0aCk7XG4gICAgICAgICAgbGV0IGZhdm9yaXRlc1VwZGF0ZWQ6IGFueVtdID0gdGhpcy5mYXZvcml0ZXNcbiAgICAgICAgICAgIC5nZXRWYWx1ZSgpXG4gICAgICAgICAgICAuZmlsdGVyKGl0ZW0gPT4gaXRlbS5pZCAhPSBkaXNoLmlkKTtcbiAgICAgICAgICBjb25zb2xlLmluZm8oJ9Ch0YLQsNC70L49Pj4+JywgZmF2b3JpdGVzVXBkYXRlZC5sZW5ndGgpO1xuICAgICAgICAgIHRoaXMuZmF2b3JpdGVzLm5leHQocmVzdWx0KTtcbiAgICAgICAgfSxcbiAgICAgICAgKCkgPT4geyB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHVzZXJQcm9maWxlKCk6IE9ic2VydmFibGU8VXNlcj4ge1xuICAgIHJldHVybiB0aGlzLnVzZXIgPyB0aGlzLnVzZXIgOiB0aGlzLmdldFByb2ZpbGUoKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0RmF2b3JpdGVzKCkpLFxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0QWRkcmVzc2VzKCkpLFxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0Qm9udXNlcygpKSxcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLnVzZXIpXG4gICAgKTtcbiAgfVxuXG4gIHVzZXJJc0xvZ2dlZEluKCk6IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuaXNMb2dnZWRJbjtcbiAgfVxuXG4gIHVzZXJGYXZvcml0ZXMoKTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xuICAgIHJldHVybiB0aGlzLmZhdm9yaXRlcyA/IHRoaXMuZmF2b3JpdGVzLmFzT2JzZXJ2YWJsZSgpIDogb2YoW10pO1xuICB9XG5cbiAgdXNlckFkZHJlc3NlcygpOiBPYnNlcnZhYmxlPEFkZHJlc3NbXT4ge1xuICAgIHJldHVybiB0aGlzLmFkZHJlc3NlcyA/IHRoaXMuYWRkcmVzc2VzLmFzT2JzZXJ2YWJsZSgpIDogb2YoW10pO1xuICB9XG5cbiAgdXNlckhpc3RvcnkoKTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnlJdGVtcyA/IHRoaXMuaGlzdG9yeUl0ZW1zLmFzT2JzZXJ2YWJsZSgpIDogb2YoW10pO1xuICB9XG5cbiAgdXNlclRyYW5zYWN0aW9uc0hpc3RvcnkoKTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnlUcmFuc2FjdGlvbnMgPyB0aGlzLmhpc3RvcnlUcmFuc2FjdGlvbnMuYXNPYnNlcnZhYmxlKCkgOiBvZihbXSk7XG4gIH1cblxuICBnZXRBdXRoVG9rZW4oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5hdXRoVG9rZW47XG4gIH1cblxuICBzZXRBdXRoVG9rZW4oYXV0aFRva2VuOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5yZW1lbWJlck1lKSB7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShMU19UT0tFTl9OQU1FLCBhdXRoVG9rZW4pO1xuICAgIH07XG4gICAgdGhpcy5hdXRoVG9rZW4gPSBhdXRoVG9rZW47XG4gICAgdGhpcy5pc0xvZ2dlZEluLm5leHQodHJ1ZSk7XG4gICAgLyppZih1cGRhdGVQcm9maWxlKSB7XG4gICAgICB0aGlzLmdldFByb2ZpbGUoKS5zdWJzY3JpYmUoKTtcbiAgICAgIHRoaXMuZ2V0RmF2b3JpdGVzKCkuc3Vic2NyaWJlKCk7XG4gICAgICB0aGlzLmdldEFkZHJlc3NlcygpLnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy5nZXRIaXN0b3J5KCkuc3Vic2NyaWJlKCk7XG4gICAgfSovXG4gIH1cblxuICBkZWxldGVBdXRoVG9rZW4oKTogdm9pZCB7XG4gICAgdGhpcy5hdXRoVG9rZW4gPSBudWxsO1xuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKExTX1RPS0VOX05BTUUpO1xuICAgIHRoaXMuaXNMb2dnZWRJbi5uZXh0KGZhbHNlKTtcbiAgfVxuXG4gIHNhdmVBdmF0YXIoYXZhdGFyOiBGaWxlKSB7XG4gICAgY29uc3QgZGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgIGRhdGEuYXBwZW5kKCdhdmF0YXInLCBhdmF0YXIsIGF2YXRhci5uYW1lKTtcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL3VzZXIvYXZhdGFyL3VwbG9hZCcsIGRhdGEsIHRydWUsIHtcbiAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdtdWx0aXBhcnQvZm9ybS1kYXRhJyB9LFxuICAgIH0pLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgIHJlc3VsdCA9PiB0aGlzLnVzZXIubmV4dChyZXN1bHQudXNlciksXG4gICAgICAgICgpID0+IHsgfVxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==